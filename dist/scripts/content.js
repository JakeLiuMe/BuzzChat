!function(){"use strict";!function(){const e="undefined"!=typeof BuzzChatSecurity?BuzzChatSecurity:null;e&&!e.isIntact()&&console.error("[BuzzChat] Security integrity check failed"),window.addEventListener("error",function(t){e&&e.wrapError(t.error||new Error(t.message),"global")}),window.addEventListener("unhandledrejection",function(t){e&&e.wrapError(t.reason||new Error("Unhandled rejection"),"promise")}),Promise.resolve().then(function(){return X}).then(({InitManager:e})=>{e.start()}).catch(e=>{console.error("[BuzzChat] Failed to load modules:",e)})}();const e="undefined"!=typeof browser?browser:chrome,t=500,n=1e3,s=50,a=100,i=500,o=5e3,r=1e4,c={MAX_MESSAGES_PER_MINUTE:10,MESSAGE_COOLDOWN_MS:6e3,MAX_MESSAGE_LENGTH:500};class l{constructor(e){this.maxSize=e,this.cache=new Map}add(e){if(this.cache.has(e)&&this.cache.delete(e),this.cache.set(e,!0),this.cache.size>this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}}has(e){return this.cache.has(e)}get size(){return this.cache.size}clear(){this.cache.clear()}}class u{constructor(e){this.maxSize=e,this.cache=new Map}set(e,t){if(this.cache.has(e)&&this.cache.delete(e),this.cache.set(e,t),this.cache.size>this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}}get(e){if(!this.cache.has(e))return;const t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}has(e){return this.cache.has(e)}delete(e){return this.cache.delete(e)}get size(){return this.cache.size}clear(){this.cache.clear()}keys(){return this.cache.keys()}values(){return this.cache.values()}entries(){return this.cache.entries()}}const d={pendingWrites:{},writeScheduled:!1,BATCH_DELAY_MS:1e3,queue(e,t){this.pendingWrites[e]=t,this.writeScheduled||(this.writeScheduled=!0,setTimeout(()=>this.flush(),this.BATCH_DELAY_MS))},flush(){this.writeScheduled=!1;const t={...this.pendingWrites};this.pendingWrites={},Object.keys(t).length>0&&e.storage.sync.set(t,()=>{e.runtime.lastError&&console.error("[BuzzChat] Storage write error:",e.runtime.lastError)})},writeNow(t,n){e.storage.sync.set({[t]:n})}},m={settings:null,isLiveStream:!1,platform:null,chatInput:null,chatContainer:null,sendButton:null,welcomedUsers:new l(t),processedMessages:new l(n),timerIntervals:[],observer:null,initialized:!1,isStartingTimers:!1,selectors:null,messageTimestamps:[],lastMessageTime:0,userMessageHistory:new u(i),giveawayEntries:new u(o),chatMetrics:{messagesThisMinute:0,uniqueChattersThisSession:new l(r),messageTimestamps:[],peakMessagesPerMinute:0}},p={chatInput:['textarea[placeholder*="chat"]','textarea[placeholder*="message"]','input[placeholder*="chat"]','input[placeholder*="message"]','[data-testid="chat-input"]',".chat-input textarea",".chat-input input",'[class*="ChatInput"] textarea','[class*="ChatInput"] input'],chatContainer:['[data-testid="chat-messages"]',".chat-messages",'[class*="ChatMessages"]','[class*="chat-container"]','[class*="ChatContainer"]','[class*="LiveChat"]'],sendButton:['button[type="submit"]','[data-testid="send-button"]',".chat-send-button",'[class*="SendButton"]','button[aria-label*="send"]'],messageItem:['[data-testid="chat-message"]',".chat-message",'[class*="ChatMessage"]','[class*="message-item"]'],username:['[data-testid="username"]',".username",'[class*="Username"]','[class*="user-name"]','span[class*="name"]'],messageText:['[data-testid="message-text"]',".message-text",'[class*="MessageText"]','[class*="message-content"]'],liveIndicator:['[data-testid="live-indicator"]',".live-badge",'[class*="LiveBadge"]','[class*="live-indicator"]','span:contains("LIVE")']},g={chatInput:null,chatContainer:null,sendButton:null,messageItem:null,username:null,messageText:null,liveIndicator:null};function h(){return m.selectors||p}function f(){return!!m.settings&&(!!function(){const e=Date.now();return e-m.lastMessageTime<c.MESSAGE_COOLDOWN_MS?(console.warn("[BuzzChat] Rate limit: Cooldown not elapsed"),!1):(m.messageTimestamps=m.messageTimestamps.filter(t=>e-t<6e4),!(m.messageTimestamps.length>=c.MAX_MESSAGES_PER_MINUTE&&(console.warn("[BuzzChat] Rate limit: Too many messages per minute"),1)))}()&&("pro"===m.settings.tier||"business"===m.settings.tier||(!(m.settings.messagesUsed>=m.settings.messagesLimit)||(console.warn("[BuzzChat] Message limit reached. Upgrade to Pro for unlimited messages."),!1))))}function y(e,t=null){if(t&&g[t])try{const e=document.querySelector(g[t]);if(e)return e;g[t]=null}catch(e){g[t]=null}for(const n of e)try{const e=document.querySelector(n);if(e)return t&&(g[t]=n),e}catch(e){}return null}function b(t){if(!t)return!1;let n=t.trim();if(m.settings?.settings?.watermark&&"free"===m.settings.tier){const e=" - BuzzChat",t=c.MAX_MESSAGE_LENGTH-e.length;n.length>t&&(n=n.substring(0,t)),n+=e}else n.length>c.MAX_MESSAGE_LENGTH&&(console.warn(`[BuzzChat] Message truncated from ${n.length} to ${c.MAX_MESSAGE_LENGTH} chars`),n=n.substring(0,c.MAX_MESSAGE_LENGTH));if(!n)return!1;const s=h();if(!m.chatInput&&(m.chatInput=y(s.chatInput,"chatInput"),m.settings?.settings?.chatSelector))try{m.chatInput=document.querySelector(m.settings.settings.chatSelector)||m.chatInput}catch(e){}if(!m.chatInput)return console.error("[BuzzChat] Chat input not found"),!1;const i=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set||Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set;return i?i.call(m.chatInput,n):m.chatInput.value=n,function(){const e=Date.now();m.messageTimestamps.push(e),m.lastMessageTime=e}(),"free"===m.settings.tier&&(m.settings.messagesUsed++,d.queue("buzzchatSettings",m.settings),e.runtime.sendMessage({type:"MESSAGE_SENT"})),m.chatInput.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout(()=>{m.sendButton=y(s.sendButton,"sendButton"),m.sendButton?m.sendButton.click():(m.chatInput.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0})),m.chatInput.dispatchEvent(new KeyboardEvent("keypress",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0})),m.chatInput.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0}))),console.log(`[BuzzChat] Message sent: ${n.substring(0,50)}...`)},a),!0}function z(e,t={}){if("undefined"!=typeof Analytics&&"function"==typeof Analytics.trackMessage&&!0===Analytics.__BUZZCHAT_VERIFIED)try{const n=String(e).slice(0,50),s={};if(t&&"object"==typeof t)for(const[e,n]of Object.entries(t))"string"==typeof e&&e.length<50&&(s[e]="string"==typeof n?n.slice(0,200):n);Analytics.trackMessage(n,s)}catch(e){console.warn("[BuzzChat] Analytics tracking failed:",e)}}async function C(e,t){const n="undefined"!=typeof window&&window.AIService?window.AIService:null,s="undefined"!=typeof window&&window.AnthropicKeyManager?window.AnthropicKeyManager:null;if(!n||!s)return console.warn("[BuzzChat] AI service not available"),null;if("max"!==m.settings?.tier)return null;try{const a=await s.getKey();if(!a)return console.warn("[BuzzChat] No Anthropic API key configured"),null;const i={platform:m.platform?.name||"live stream",sellerName:m.settings?.sellerName||null,currentItem:m.currentItem||null,additionalContext:t.aiContext||null},o=await n.generateAIResponse({userMessage:e,context:i,tone:t.aiTone||"friendly",apiKey:a});return z("ai_response",{inputTokens:o.usage.inputTokens,outputTokens:o.usage.outputTokens,trigger:t.triggers?.[0]||"unknown"}),o.text}catch(e){return console.error("[BuzzChat] AI response failed:",e.message),null}}const w=new Map;setInterval(()=>{const e=Date.now();for(const[t,n]of w.entries())e-n>36e5&&w.delete(t)},36e5);const x="repeated_question",E="high_activity",k={shipping:["shipping","ship","delivery","deliver","when will","how long","tracking"],price:["price","cost","how much","dollars","$","discount","deal"],size:["size","dimensions","big","small","fit","measure"],availability:["available","in stock","left","remaining","more","sold out"],payment:["pay","payment","venmo","paypal","card","credit"],condition:["condition","new","used","damage","worn","authentic","real","fake"],return:["return","refund","exchange","money back"]},v={questionCounts:new u(50),recentMessages:[],lastInsightTime:0,activeInsights:[],dismissed:new Set};function M(e){return{shipping:"Send shipping info? (Usually ships in 1-3 business days)",price:"Announce current price or any deals?",size:"Share size/dimensions info?",availability:"Update on stock availability?",payment:"Clarify payment methods accepted?",condition:"Confirm item condition/authenticity?",return:"Share your return policy?"}[e]||"Address this in chat?"}function S(e,t){const n=Date.now();if(n-v.lastInsightTime<6e4)return;const s=`${e}-${t.category||t.messagesPerMinute}`;if(v.dismissed.has(s))return;v.lastInsightTime=n;const a={id:`insight-${n}`,type:e,data:t,time:n};v.activeInsights.push(a),function(e){const t=document.getElementById("buzzchat-insight");t&&t.remove();const n=document.createElement("div");if(n.id="buzzchat-insight",n.style.cssText="\n    position: fixed;\n    bottom: 200px;\n    right: 20px;\n    max-width: 280px;\n    padding: 16px;\n    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);\n    color: white;\n    border-radius: 12px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 13px;\n    z-index: 10002;\n    box-shadow: 0 8px 24px rgba(0,0,0,0.3);\n    animation: slideInRight 0.3s ease;\n    border: 1px solid rgba(255,255,255,0.1);\n  ",!document.getElementById("buzzchat-insight-styles")){const e=document.createElement("style");e.id="buzzchat-insight-styles",e.textContent="\n      @keyframes slideInRight {\n        from { transform: translateX(100%); opacity: 0; }\n        to { transform: translateX(0); opacity: 1; }\n      }\n      @keyframes fadeOut {\n        from { opacity: 1; }\n        to { opacity: 0; }\n      }\n    ",document.head.appendChild(e)}const s=document.createElement("div");s.style.cssText="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;";const a=document.createElement("span");a.textContent="ðŸ’¡",a.style.fontSize="18px";const i=document.createElement("strong");i.textContent="BuzzChat Insight",i.style.color="#c4b5fd",s.appendChild(a),s.appendChild(i);const o=document.createElement("div");o.style.marginBottom="12px",e.type===x?o.textContent=`${e.data.count}+ people asked about ${e.data.category}. ${e.data.suggestion}`:e.type===E&&(o.textContent=`ðŸ”¥ ${e.data.messagesPerMinute} messages/min! ${e.data.suggestion}`);const r=document.createElement("div");r.style.cssText="display: flex; gap: 8px;";const c=document.createElement("button");c.textContent="Send Now",c.style.cssText="\n    flex: 1;\n    padding: 8px 12px;\n    background: #7c3aed;\n    color: white;\n    border: none;\n    border-radius: 6px;\n    cursor: pointer;\n    font-size: 12px;\n    font-weight: 500;\n  ",c.addEventListener("click",()=>{n.remove()});const l=document.createElement("button");l.textContent="Dismiss",l.style.cssText="\n    padding: 8px 12px;\n    background: transparent;\n    color: #a5b4fc;\n    border: 1px solid #4c1d95;\n    border-radius: 6px;\n    cursor: pointer;\n    font-size: 12px;\n  ",l.addEventListener("click",()=>{const t=`${e.type}-${e.data.category||e.data.messagesPerMinute}`;v.dismissed.add(t),n.style.animation="fadeOut 0.2s ease",setTimeout(()=>n.remove(),200)}),r.appendChild(c),r.appendChild(l),n.appendChild(s),n.appendChild(o),n.appendChild(r),document.body.appendChild(n),setTimeout(()=>{n.parentNode&&(n.style.animation="fadeOut 0.3s ease",setTimeout(()=>n.remove(),300))},15e3)}(a)}const T="undefined"!=typeof BuzzChatSecurity?BuzzChatSecurity:null;function B(t){const n=h(),a=t.querySelector?.(n.username.join(","))||t.matches?.(n.username.join(","))?t:null,i=t.querySelector?.(n.messageText.join(","))||t.matches?.(n.messageText.join(","))?t:null;let o="",r="";if(a&&(o=a.textContent?.trim()||""),i&&(r=i.textContent?.trim()||""),!o&&!r&&t.textContent){const e=t.textContent.trim(),n=e.indexOf(": ");n>0&&n<s&&(o=e.substring(0,n).trim(),r=e.substring(n+2).trim())}if(!o||!r)return;const c=`${o}-${r}-${Date.now()}`;if(!m.processedMessages.has(c))if(m.processedMessages.add(c),console.log(`[BuzzChat] New message from ${o}: ${r}`),function(t){const n=Date.now(),s=m.chatMetrics;s.uniqueChattersThisSession.add(t),s.messageTimestamps.push(n),s.messageTimestamps=s.messageTimestamps.filter(e=>n-e<6e4),s.messagesThisMinute=s.messageTimestamps.length,s.messagesThisMinute>s.peakMessagesPerMinute&&(s.peakMessagesPerMinute=s.messagesThisMinute),s.messageTimestamps.length%10==0&&e.runtime.sendMessage({type:"CHAT_METRICS_UPDATE",metrics:{messagesPerMinute:s.messagesThisMinute,uniqueChatters:s.uniqueChattersThisSession.size,peakMessagesPerMinute:s.peakMessagesPerMinute}}).catch(e=>console.warn("[BuzzChat] Metrics update failed:",e?.message||"unknown"))}(o),function(e,t){if(!e||!m.settings?.masterEnabled)return;const n=e.toLowerCase(),s=Date.now();v.recentMessages.push({message:n,username:t,time:s}),v.recentMessages.length>50&&v.recentMessages.shift();for(const[e,t]of Object.entries(k))for(const s of t)if(n.includes(s)){const t=(v.questionCounts.get(e)||0)+1;v.questionCounts.set(e,t),t>=3&&(S(x,{category:e,count:t,suggestion:M(e)}),v.questionCounts.set(e,0));break}const a=s-6e4,i=v.recentMessages.filter(e=>e.time>a).length;i>=20&&S(E,{messagesPerMinute:i,suggestion:"Chat is popping! Great time to promote."})}(r,o),m.settings?.moderation?.enabled&&function(e,t){const n=m.settings?.moderation;if(!n)return!1;const s=e.toLowerCase();if(n.blockedWords?.length>0)for(const e of n.blockedWords)if(s.includes(e.toLowerCase()))return console.log(`[BuzzChat] Blocked word detected: "${e}"`),!0;if(n.blockRepeatedMessages){const s=m.userMessageHistory.get(t)||[],a=s.filter(t=>t.text===e&&Date.now()-t.timestamp<6e4).length;if(s.push({text:e,timestamp:Date.now()}),s.length>10&&s.shift(),m.userMessageHistory.set(t,s),a>=(n.maxRepeatCount||3))return console.log(`[BuzzChat] Repeated message detected from ${t}`),!0}return!1}(r,o))console.log(`[BuzzChat] Message blocked from ${o}`);else{if(m.settings?.giveaway?.enabled&&function(t,n){const s=m.settings?.giveaway;if(!s?.enabled)return;const a=t.toLowerCase(),i=s.keywords||["entered","entry","enter"];for(const t of i)if(a.includes(t.toLowerCase()))return s.uniqueOnly&&m.giveawayEntries.has(n)?void console.log(`[BuzzChat] Duplicate giveaway entry from ${n} (ignored)`):(m.giveawayEntries.set(n,Date.now()),console.log(`[BuzzChat] Giveaway entry recorded: ${n} (total: ${m.giveawayEntries.size})`),void e.runtime.sendMessage({type:"GIVEAWAY_ENTRY",username:n,totalEntries:m.giveawayEntries.size}).catch(e=>console.warn("[BuzzChat] Giveaway notification failed:",e?.message||"unknown")))}(r,o),m.settings?.welcome?.enabled&&!m.welcomedUsers.has(o)&&function(e){if(!f())return;m.welcomedUsers.add(e);const t=m.settings.welcome.message.split("{username}").join(e);setTimeout(()=>{b(t),z("welcome")},1e3*(m.settings.welcome.delay||5)),console.log(`[BuzzChat] Queued welcome message for ${e}`)}(o),m.settings?.commands?.enabled&&r.startsWith("!")){const t=function(t,n){const s=m.settings?.commands?.list||[];if(0===s.length)return!1;const a=t.match(/^!(\w+)/);if(!a)return!1;const i=a[1].toLowerCase(),o=s.find(e=>e.trigger?.toLowerCase()===i);if(!o||!o.response)return!1;const r=w.get(i)||0,c=1e3*(o.cooldown||30),l=Date.now();return l-r<c?(console.log(`[BuzzChat] Command !${i} on cooldown (${Math.ceil((c-(l-r))/1e3)}s remaining)`),!0):!!f()&&(w.set(i,l),b(o.response.split("{username}").join(n)),z("command",{trigger:i}),o.usageCount=(o.usageCount||0)+1,d.queue("buzzchatSettings",m.settings),e.runtime.sendMessage({type:"COMMAND_USED",trigger:i,usageCount:o.usageCount}).catch(()=>{}),console.log(`[BuzzChat] Command !${i} executed for ${n}`),!0)}(r,o);if(t)return}m.settings?.faq?.enabled&&async function(e,t){const n=m.settings?.faq?.rules||[];for(const s of n){if(!s||"object"!=typeof s)continue;if(!Array.isArray(s.triggers)||0===s.triggers.length)continue;const n="string"==typeof s.reply&&s.reply.trim(),a=!0===s.useAI;if(!n&&!a)continue;const i=s.caseSensitive?e:e.toLowerCase();for(const o of s.triggers){const r=s.caseSensitive?o:o.toLowerCase();if(i.includes(r)){if(console.log(`[BuzzChat] FAQ trigger matched: ${o}`),f()){let i;a&&"max"===m.settings?.tier&&(i=await C(e,s)),!i&&n&&(i=s.reply.split("{username}").join(t)),i&&(b(i),z("faq",{trigger:o.toLowerCase(),aiGenerated:a&&i!==s.reply}))}return}}}}(r,o)}}function I(t,n,s,{startBot:a,stopBot:i,showQuickReplyBar:o}){if(T){if(!T.validateMessageOrigin(n))return s({success:!1,error:"Unauthorized sender"}),!0}else if(!n||n.id!==e.runtime.id)return console.warn("[BuzzChat] Message from unknown sender rejected"),s({success:!1,error:"Unauthorized sender"}),!0;if(!function(e){return!(!e||"object"!=typeof e)&&(!(!e.type||"string"!=typeof e.type)&&["SETTINGS_UPDATED","SEND_TEMPLATE","GET_GIVEAWAY_ENTRIES","RESET_GIVEAWAY","GET_CHAT_METRICS","RESET_CHAT_METRICS","SEND_QUICK_REPLY"].includes(e.type))}(t))return console.warn("[BuzzChat] Invalid message format rejected"),s({success:!1,error:"Invalid message format"}),!0;switch(console.log("[BuzzChat] Received message:",t.type),t.type){case"SETTINGS_UPDATED":{const e=(c=t.settings)&&"object"==typeof c?{tier:["free","pro","business"].includes(c.tier)?c.tier:"free",messagesUsed:"number"==typeof c.messagesUsed?Math.max(0,c.messagesUsed):0,messagesLimit:"number"==typeof c.messagesLimit?c.messagesLimit:50,masterEnabled:Boolean(c.masterEnabled),welcome:c.welcome?{enabled:Boolean(c.welcome.enabled),message:"string"==typeof c.welcome.message?c.welcome.message.slice(0,500):"",delay:"number"==typeof c.welcome.delay?Math.min(60,Math.max(1,c.welcome.delay)):5}:{enabled:!1,message:"",delay:5},timer:c.timer?{enabled:Boolean(c.timer.enabled),messages:Array.isArray(c.timer.messages)?c.timer.messages.slice(0,20):[]}:{enabled:!1,messages:[]},faq:c.faq?{enabled:Boolean(c.faq.enabled),rules:Array.isArray(c.faq.rules)?c.faq.rules.slice(0,100):[]}:{enabled:!1,rules:[]},moderation:c.moderation?{enabled:Boolean(c.moderation.enabled),blockedWords:Array.isArray(c.moderation.blockedWords)?c.moderation.blockedWords.slice(0,200):[],blockRepeatedMessages:Boolean(c.moderation.blockRepeatedMessages),maxRepeatCount:"number"==typeof c.moderation.maxRepeatCount?Math.min(10,Math.max(2,c.moderation.maxRepeatCount)):3}:{enabled:!1,blockedWords:[],blockRepeatedMessages:!1,maxRepeatCount:3},giveaway:c.giveaway?{enabled:Boolean(c.giveaway.enabled),keywords:Array.isArray(c.giveaway.keywords)?c.giveaway.keywords.slice(0,20):["entered"],uniqueOnly:!1!==c.giveaway.uniqueOnly}:{enabled:!1,keywords:["entered"],uniqueOnly:!0},templates:Array.isArray(c.templates)?c.templates.slice(0,50):[],commands:c.commands?{enabled:Boolean(c.commands.enabled),list:Array.isArray(c.commands.list)?c.commands.list.slice(0,50):[]}:{enabled:!1,list:[]},quickReply:c.quickReply?{enabled:!1!==c.quickReply.enabled,minimized:Boolean(c.quickReply.minimized),buttons:Array.isArray(c.quickReply.buttons)?c.quickReply.buttons.slice(0,10):[{text:"SOLD!",emoji:"ðŸ”¥"},{text:"Next item!",emoji:"âž¡ï¸"},{text:"5 min break",emoji:"â°"},{text:"Thanks for watching!",emoji:"ðŸ™"}]}:{enabled:!0,minimized:!1,buttons:[{text:"SOLD!",emoji:"ðŸ”¥"},{text:"Next item!",emoji:"âž¡ï¸"},{text:"5 min break",emoji:"â°"},{text:"Thanks for watching!",emoji:"ðŸ™"}]},settings:c.settings?{chatSelector:"string"==typeof c.settings.chatSelector?c.settings.chatSelector.slice(0,200):"",soundNotifications:Boolean(c.settings.soundNotifications),showMessageCount:Boolean(c.settings.showMessageCount),darkMode:Boolean(c.settings.darkMode),watermark:Boolean(c.settings.watermark)}:{chatSelector:"",soundNotifications:!0,showMessageCount:!0,darkMode:!1,watermark:!1}}:null;if(!e)return s({success:!1,error:"Invalid settings object"}),!0;m.settings=e,m.settings.masterEnabled?a():i(),m.isLiveStream&&m.settings.masterEnabled&&o(),s({success:!0});break}case"SEND_TEMPLATE":t.text&&(b(t.text),z("template")),s({success:!0});break;case"GET_GIVEAWAY_ENTRIES":s({success:!0,entries:Array.from(m.giveawayEntries.entries()).map(([e,t])=>({username:e,timestamp:t})),totalEntries:m.giveawayEntries.size});break;case"RESET_GIVEAWAY":m.giveawayEntries.clear(),console.log("[BuzzChat] Giveaway entries reset"),s({success:!0});break;case"GET_CHAT_METRICS":s({success:!0,metrics:{messagesPerMinute:m.chatMetrics.messagesThisMinute,uniqueChatters:m.chatMetrics.uniqueChattersThisSession.size,peakMessagesPerMinute:m.chatMetrics.peakMessagesPerMinute}});break;case"RESET_CHAT_METRICS":m.chatMetrics={messagesThisMinute:0,uniqueChattersThisSession:new l(r),messageTimestamps:[],peakMessagesPerMinute:0},console.log("[BuzzChat] Chat metrics reset"),s({success:!0});break;case"SEND_QUICK_REPLY":if(t.text&&"string"==typeof t.text){const e=b(t.text.slice(0,500));e&&z("quickReply"),s({success:e})}else s({success:!1,error:"Invalid message text"});break;default:s({success:!1,error:"Unknown message type"})}var c;return!0}function q(e){let t=document.getElementById("buzzchat-indicator");for(t||(t=document.createElement("div"),t.id="buzzchat-indicator",document.body.appendChild(t));t.firstChild;)t.removeChild(t.firstChild);const n=document.createElement("div");if(n.style.cssText=`\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    padding: 8px 16px;\n    background: ${e?"#7c3aed":"#6b7280"};\n    color: white;\n    border-radius: 20px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 12px;\n    font-weight: 500;\n    z-index: 10000;\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n    cursor: pointer;\n    transition: all 0.2s;\n  `,!document.getElementById("buzzchat-pulse-animation")){const e=document.createElement("style");e.id="buzzchat-pulse-animation",e.textContent="\n      @keyframes buzzchat-pulse {\n        0%, 100% { opacity: 1; transform: scale(1); }\n        50% { opacity: 0.7; transform: scale(1.2); }\n      }\n      .buzzchat-pulse {\n        animation: buzzchat-pulse 2s ease-in-out infinite;\n      }\n    ",document.head.appendChild(e)}const s=document.createElement("span");s.style.cssText=`\n    width: 8px;\n    height: 8px;\n    background: ${m.settings?.masterEnabled?"#10b981":"#ef4444"};\n    border-radius: 50%;\n  `,m.settings?.masterEnabled&&s.classList.add("buzzchat-pulse");const a=document.createTextNode("BuzzChat "+(m.settings?.masterEnabled?"Active":"Inactive"));n.appendChild(s),n.appendChild(a),t.appendChild(n),n.addEventListener("click",()=>{console.log("[BuzzChat] Click the extension icon to open settings")})}function A(e){if(!m.settings?.settings?.soundNotifications)return;const t=document.createElement("div");if(t.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    padding: 12px 20px;\n    background: #1f2937;\n    color: white;\n    border-radius: 8px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 13px;\n    z-index: 10001;\n    box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n    animation: slideIn 0.3s ease;\n  ",t.textContent=e,!document.getElementById("buzzchat-animations")){const e=document.createElement("style");e.id="buzzchat-animations",e.textContent="\n      @keyframes slideIn {\n        from { transform: translateX(100%); opacity: 0; }\n        to { transform: translateX(0); opacity: 1; }\n      }\n      @keyframes slideOut {\n        from { transform: translateX(0); opacity: 1; }\n        to { transform: translateX(100%); opacity: 0; }\n      }\n    ",document.head.appendChild(e)}document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOut 0.3s ease",setTimeout(()=>t.remove(),300)},3e3)}function R(){if(!m.isLiveStream)return;const e=m.settings?.quickReply;if(!e?.enabled)return void _();let t=document.getElementById("buzzchat-quick-reply");if(!t&&(t=document.createElement("div"),t.id="buzzchat-quick-reply",document.body.appendChild(t),!document.getElementById("buzzchat-quickreply-styles"))){const e=document.createElement("style");e.id="buzzchat-quickreply-styles",e.textContent='\n        #buzzchat-quick-reply {\n          position: fixed;\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n          z-index: 9999;\n          transition: all 0.3s ease;\n        }\n        #buzzchat-quick-reply[data-position="bottom-right"] {\n          bottom: 80px;\n          right: 20px;\n        }\n        #buzzchat-quick-reply[data-position="bottom-left"] {\n          bottom: 80px;\n          left: 20px;\n        }\n        #buzzchat-quick-reply[data-position="top-right"] {\n          top: 80px;\n          right: 20px;\n        }\n        #buzzchat-quick-reply[data-position="top-left"] {\n          top: 80px;\n          left: 20px;\n        }\n        #buzzchat-quick-reply.minimized .quick-reply-buttons {\n          display: none;\n        }\n        #buzzchat-quick-reply .quick-reply-toggle {\n          align-self: flex-end;\n          width: 40px;\n          height: 40px;\n          border-radius: 50%;\n          background: #7c3aed;\n          color: white;\n          border: none;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 18px;\n          box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);\n          transition: all 0.2s;\n        }\n        #buzzchat-quick-reply .quick-reply-toggle:hover {\n          transform: scale(1.1);\n          box-shadow: 0 6px 16px rgba(124, 58, 237, 0.4);\n        }\n        #buzzchat-quick-reply .quick-reply-buttons {\n          display: flex;\n          flex-direction: column;\n          gap: 6px;\n        }\n        #buzzchat-quick-reply .quick-reply-btn {\n          padding: 10px 16px;\n          background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);\n          color: white;\n          border: none;\n          border-radius: 20px;\n          cursor: pointer;\n          font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n          font-size: 13px;\n          font-weight: 500;\n          display: flex;\n          align-items: center;\n          gap: 6px;\n          box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);\n          transition: all 0.2s;\n          white-space: nowrap;\n        }\n        #buzzchat-quick-reply .quick-reply-btn:hover {\n          transform: translateX(-5px);\n          box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);\n        }\n        #buzzchat-quick-reply .quick-reply-btn:active {\n          transform: scale(0.95);\n        }\n        #buzzchat-quick-reply .quick-reply-btn.sending {\n          opacity: 0.7;\n          pointer-events: none;\n        }\n        #buzzchat-quick-reply .quick-reply-emoji {\n          font-size: 16px;\n        }\n        #buzzchat-quick-reply .quick-reply-shortcut {\n          font-size: 10px;\n          background: rgba(255,255,255,0.2);\n          padding: 2px 6px;\n          border-radius: 4px;\n          margin-left: auto;\n          font-weight: 600;\n        }\n      ',document.head.appendChild(e)}const n=e.position||"bottom-right";for(t.setAttribute("data-position",n);t.firstChild;)t.removeChild(t.firstChild);const s=document.createElement("button");s.className="quick-reply-toggle",s.textContent=e.minimized?"ðŸ’¬":"âœ•",s.title=e.minimized?"Show quick replies":"Hide quick replies",s.dataset.action="toggle",t.appendChild(s);const a=document.createElement("div");a.className="quick-reply-buttons";(e.buttons||[]).forEach((e,t)=>{const n=document.createElement("button");if(n.className="quick-reply-btn",n.dataset.action="send",n.dataset.index=t,n.dataset.text=e.text||"",e.emoji){const t=document.createElement("span");t.className="quick-reply-emoji",t.textContent=e.emoji,n.appendChild(t)}const s=document.createTextNode(e.text||"");if(n.appendChild(s),t<9){const e=document.createElement("span");e.className="quick-reply-shortcut",e.textContent=String(t+1),e.title=`Press ${t+1} to send`,n.appendChild(e)}a.appendChild(n)}),t.appendChild(a),t.dataset.delegated||(t.dataset.delegated="true",t.addEventListener("click",e=>{const n=e.target.closest("button");if(!n)return;const s=n.dataset.action;if("toggle"===s)m.settings.quickReply.minimized=!m.settings.quickReply.minimized,t.classList.toggle("minimized"),n.textContent=m.settings.quickReply.minimized?"ðŸ’¬":"âœ•",n.title=m.settings.quickReply.minimized?"Show quick replies":"Hide quick replies",d.queue("buzzchatSettings",m.settings);else if("send"===s){if(n.classList.contains("sending"))return;n.classList.add("sending");const e=n.dataset.text;if(e&&f()){b(e)&&(z("quickReply"),function(e){const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    bottom: 140px;\n    right: 20px;\n    padding: 8px 14px;\n    background: #10b981;\n    color: white;\n    border-radius: 16px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 12px;\n    font-weight: 500;\n    z-index: 10001;\n    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    animation: slideIn 0.2s ease;\n    max-width: 200px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  ";const n=document.createElement("span");n.textContent="âœ“",n.style.fontWeight="bold";const s=document.createElement("span"),a=e.length>20?e.slice(0,20)+"...":e;s.textContent=a,t.appendChild(n),t.appendChild(s),document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOut 0.2s ease",setTimeout(()=>t.remove(),200)},1500)}(e))}setTimeout(()=>{n.classList.remove("sending")},1e3)}}),document.addEventListener("keydown",e=>{const n=document.activeElement;if(n&&("INPUT"===n.tagName||"TEXTAREA"===n.tagName||n.isContentEditable))return;if(m.settings?.quickReply?.minimized)return;const s=parseInt(e.key);if(s>=1&&s<=9){const n=s-1;if(n<(m.settings?.quickReply?.buttons||[]).length){e.preventDefault();const s=t.querySelector(`[data-index="${n}"]`);s&&!s.classList.contains("sending")&&s.click()}}})),e.minimized&&t.classList.add("minimized")}function _(){const e=document.getElementById("buzzchat-quick-reply");e&&e.remove()}const L="undefined"!=typeof BuzzChatPlatform&&BuzzChatPlatform.__BUZZCHAT_VERIFIED?BuzzChatPlatform:null,N="undefined"!=typeof BuzzChatSecurity?BuzzChatSecurity:null;function j(){return{tier:"free",messagesUsed:0,messagesLimit:50,masterEnabled:!1,welcome:{enabled:!1,message:"Hey {username}! Welcome to the stream!",delay:5},timer:{enabled:!1,messages:[]},faq:{enabled:!1,rules:[]},moderation:{enabled:!1,blockedWords:[],blockRepeatedMessages:!1,maxRepeatCount:3},giveaway:{enabled:!1,keywords:["entered","entry","enter"],entries:[],uniqueOnly:!0},templates:[],commands:{enabled:!1,list:[]},quickReply:{enabled:!0,minimized:!1,buttons:[{text:"SOLD!",emoji:"ðŸ”¥"},{text:"Next item!",emoji:"âž¡ï¸"},{text:"5 min break",emoji:"â°"},{text:"Thanks for watching!",emoji:"ðŸ™"}]},settings:{chatSelector:"",soundNotifications:!0,showMessageCount:!0,darkMode:!1,watermark:!1}}}async function D(){return new Promise(t=>{e.storage.sync.get(["buzzchatSettings"],e=>{m.settings=e.buzzchatSettings||{tier:"free",messagesUsed:0,messagesLimit:50,masterEnabled:!1,welcome:{enabled:!1,message:"Hey {username}! Welcome to the stream!",delay:5},timer:{enabled:!1,messages:[]},faq:{enabled:!1,rules:[]},moderation:{enabled:!1,blockedWords:[],blockRepeatedMessages:!1,maxRepeatCount:3},giveaway:{enabled:!1,keywords:["entered","entry","enter"],entries:[],uniqueOnly:!0},templates:[],commands:{enabled:!1,list:[]},quickReply:{enabled:!0,minimized:!1,buttons:[{text:"SOLD!",emoji:"ðŸ”¥"},{text:"Next item!",emoji:"âž¡ï¸"},{text:"5 min break",emoji:"â°"},{text:"Thanks for watching!",emoji:"ðŸ™"}]},settings:{chatSelector:"",soundNotifications:!0,showMessageCount:!0,darkMode:!1,watermark:!1}},t()})})}function $(){const e=h();m.chatInput=y(e.chatInput,"chatInput"),m.chatContainer=y(e.chatContainer,"chatContainer"),m.sendButton=y(e.sendButton,"sendButton");const t=y(e.liveIndicator,"liveIndicator");m.isLiveStream=!!(m.chatInput||m.chatContainer||t),m.isLiveStream?(console.log("[BuzzChat] Live stream detected"),q(!0),m.settings?.masterEnabled&&U()):(console.log("[BuzzChat] Not a live stream page"),q(!1))}function P(){const e=function(e,t){let n=null;return function(...s){n&&clearTimeout(n),n=setTimeout(()=>e.apply(this,s),t)}}(()=>{m.chatInput&&m.chatContainer||$()},250);new MutationObserver(t=>{t.some(e=>e.addedNodes.length>0)&&e()}).observe(document.body,{childList:!0,subtree:!0})}function O(){const e=h();if(!m.chatContainer&&(m.chatContainer=y(e.chatContainer,"chatContainer"),!m.chatContainer))return void console.warn("[BuzzChat] Chat container not found");m.observer&&m.observer.disconnect();const t=[];let n=!1;const s=()=>{n=!1;const e=t.splice(0,t.length);for(const t of e)try{B(t)}catch(e){console.error("[BuzzChat] Error processing message:",e)}};m.observer=new MutationObserver(e=>{for(const n of e)for(const e of n.addedNodes)e.nodeType===Node.ELEMENT_NODE&&t.push(e);t.length>0&&!n&&(n=!0,requestAnimationFrame(s))}),m.observer.observe(m.chatContainer,{childList:!0,subtree:!0}),console.log("[BuzzChat] Chat observer started")}function U(){m.isLiveStream&&m.settings?.masterEnabled&&(console.log("[BuzzChat] Starting bot..."),O(),function(){if(m.isStartingTimers)return;if(m.isStartingTimers=!0,m.timerIntervals.forEach(clearInterval),m.timerIntervals=[],!m.settings?.timer?.enabled)return void(m.isStartingTimers=!1);(m.settings.timer.messages||[]).forEach((e,t)=>{if(!e.text||!e.interval)return;const n=60*e.interval*1e3,s=setInterval(()=>{f()&&(b(e.text),z("timer"),console.log(`[BuzzChat] Timer message #${t+1} sent`))},n);m.timerIntervals.push(s),console.log(`[BuzzChat] Timer message #${t+1} scheduled every ${e.interval} minutes`)}),m.isStartingTimers=!1}(),R(),A("BuzzChat is now active!"))}function G(){console.log("[BuzzChat] Stopping bot..."),m.timerIntervals.forEach(clearInterval),m.timerIntervals=[],m.observer&&(m.observer.disconnect(),m.observer=null),_(),A("BuzzChat stopped")}async function W(){if(!m.initialized){if(console.log("[BuzzChat] Initializing..."),L){if(m.platform=L.detectPlatform(),!m.platform)return void console.log("[BuzzChat] Platform not supported, extension will not activate");console.log(`[BuzzChat] Platform detected: ${m.platform.name}`)}else m.platform={id:"whatnot",name:"Whatnot",features:["chat","giveaway","moderation","welcome","faq","timer","commands"],detected:!0},console.log("[BuzzChat] Platform detection not available, defaulting to Whatnot");if("undefined"!=typeof SelectorManager&&"function"==typeof SelectorManager.getSelectors&&"function"==typeof SelectorManager.getVersion&&!0===SelectorManager.__BUZZCHAT_VERIFIED)try{m.platform&&m.platform.id&&SelectorManager.setPlatform(m.platform.id);const e=await SelectorManager.getSelectors(m.platform?.id);if(function(e){if(!e||"object"!=typeof e)return!1;const t=["chatInput","chatContainer","sendButton"];for(const n of t){if(!Array.isArray(e[n]))return!1;if(!e[n].every(e=>"string"==typeof e&&e.length<500))return!1}return!0}(e)){m.selectors=e;const t=await SelectorManager.getVersion();console.log("[BuzzChat] Loaded selectors for "+(m.platform?.name||"unknown")+" v"+t)}else console.warn("[BuzzChat] Invalid selector format, using fallback"),m.selectors=p}catch(e){console.warn("[BuzzChat] Failed to load selectors, using fallback:",e),m.selectors=p}else m.selectors=p;await D(),$(),e.runtime.onMessage.addListener((e,t,n)=>I(e,t,n,{startBot:U,stopBot:G,showQuickReplyBar:R})),P(),m.initialized=!0,console.log("[BuzzChat] Initialized successfully")}}N?N.Logger:console;const H={MAX_RETRIES:3,RETRY_DELAYS:[0,2e3,5e3],retryCount:0,async start(){"loading"===document.readyState&&await new Promise(e=>{document.addEventListener("DOMContentLoaded",e,{once:!0})}),await this.tryInit()},async tryInit(){if(!m.initialized)try{if(await W(),m.chatContainer||m.chatInput)return void console.log("[BuzzChat] Successfully initialized with chat elements");if(this.retryCount<this.MAX_RETRIES-1){this.retryCount++;const e=this.RETRY_DELAYS[this.retryCount];console.log(`[BuzzChat] Chat elements not found, retrying in ${e}ms (attempt ${this.retryCount+1}/${this.MAX_RETRIES})`),m.initialized=!1,setTimeout(()=>this.tryInit(),e)}else console.log("[BuzzChat] Initialized (chat elements may load dynamically)")}catch(e){console.error("[BuzzChat] Initialization error:",e)}}};var X=Object.freeze({__proto__:null,InitManager:H,detectLiveStream:$,getDefaultSettings:j,init:W,loadSettings:D,startBot:U,startChatObserver:O,startPageObserver:P,stopBot:G})}();
