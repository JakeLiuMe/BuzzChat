!function(){"use strict";const e="undefined"!=typeof browser?browser:chrome,t=500,n=10,a=20,s=3,i=50,o=5,r=1,c=60,l=1,d=60,u=20,m=10,g={tier:"free",messagesUsed:0,messagesLimit:50,referralBonus:0,masterEnabled:!1,welcome:{enabled:!1,message:"Hey {username}! Welcome to the stream!",delay:5},timer:{enabled:!1,messages:[]},faq:{enabled:!1,rules:[]},moderation:{enabled:!1,blockedWords:[],blockRepeatedMessages:!1,maxRepeatCount:3},giveaway:{enabled:!1,keywords:["entered","entry","enter"],entries:[],uniqueOnly:!0},templates:[],commands:{enabled:!1,list:[]},quickReply:{enabled:!0,minimized:!1,buttons:[{text:"SOLD!",emoji:"üî•"},{text:"Next item!",emoji:"‚û°Ô∏è"},{text:"5 min break",emoji:"‚è∞"},{text:"Thanks for watching!",emoji:"üôè"}]},settings:{chatSelector:"",soundNotifications:!0,showMessageCount:!0,darkMode:!1,watermark:!1}};let y={...g};function p(e){y=e}let h=!1;function w(e){h=e}let v=[],f=[];function E(e){v=e}function B(e){f=e}var b=Object.freeze({__proto__:null,get currentWinners(){return v},get giveawayEntries(){return f},setCurrentWinners:E,setGiveawayEntries:B,setSettings:p,setUseAccountManager:w,get settings(){return y},get useAccountManager(){return h}});const C={STORAGE_KEYS:{ACCOUNTS:"buzzchatAccounts",ACTIVE_ID:"buzzchatActiveAccountId"},MAX_ACCOUNTS:10,createDefaultAccount:(e="default",t="Default")=>({id:e,name:t,createdAt:Date.now(),settings:{...g}}),generateAccountId:()=>"account_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5),async getAccounts(){return new Promise(t=>{e.storage.sync.get([this.STORAGE_KEYS.ACCOUNTS],e=>{t(e[this.STORAGE_KEYS.ACCOUNTS]||{})})})},async getActiveAccountId(){return new Promise(t=>{e.storage.sync.get([this.STORAGE_KEYS.ACTIVE_ID],e=>{t(e[this.STORAGE_KEYS.ACTIVE_ID]||"default")})})},async setActiveAccount(t){if(!(await this.getAccounts())[t])throw new Error(`Account ${t} does not exist`);return new Promise((n,a)=>{e.storage.sync.set({[this.STORAGE_KEYS.ACTIVE_ID]:t},()=>{e.runtime.lastError?a(e.runtime.lastError):n()})})},async createAccount(t){const n=await this.getAccounts();if(Object.keys(n).length>=this.MAX_ACCOUNTS)throw new Error(`Maximum of ${this.MAX_ACCOUNTS} accounts reached`);const a=(t||"").trim().slice(0,50);if(!a)throw new Error("Account name cannot be empty");const s=this.generateAccountId(),i=this.createDefaultAccount(s,a);return n[s]=i,new Promise((t,a)=>{e.storage.sync.set({[this.STORAGE_KEYS.ACCOUNTS]:n},()=>{e.runtime.lastError?a(e.runtime.lastError):t(i)})})},async deleteAccount(t){if("default"===t)throw new Error("Cannot delete the default account");const n=await this.getAccounts();if(!n[t])throw new Error(`Account ${t} does not exist`);delete n[t];const a=await this.getActiveAccountId(),s={[this.STORAGE_KEYS.ACCOUNTS]:n};return a===t&&(s[this.STORAGE_KEYS.ACTIVE_ID]="default"),new Promise((t,n)=>{e.storage.sync.set(s,()=>{e.runtime.lastError?n(e.runtime.lastError):t()})})},async renameAccount(t,n){const a=await this.getAccounts();if(!a[t])throw new Error(`Account ${t} does not exist`);const s=(n||"").trim().slice(0,50);if(!s)throw new Error("Account name cannot be empty");return a[t].name=s,new Promise((t,n)=>{e.storage.sync.set({[this.STORAGE_KEYS.ACCOUNTS]:a},()=>{e.runtime.lastError?n(e.runtime.lastError):t()})})},async getActiveSettings(){const e=await this.getAccounts(),t=await this.getActiveAccountId();return 0===Object.keys(e).length?null:e[t]?.settings||e.default?.settings||null},async updateActiveSettings(t){const n=await this.getAccounts(),a=await this.getActiveAccountId();if(!n[a])throw new Error("No active account found");return n[a].settings=this.deepMerge(n[a].settings,t),new Promise((t,s)=>{e.storage.sync.set({[this.STORAGE_KEYS.ACCOUNTS]:n},()=>{e.runtime.lastError?s(e.runtime.lastError):t(n[a].settings)})})},async migrateFromLegacy(){return new Promise(t=>{e.storage.sync.get(["buzzchatSettings",this.STORAGE_KEYS.ACCOUNTS],async n=>{if(n[this.STORAGE_KEYS.ACCOUNTS]&&Object.keys(n[this.STORAGE_KEYS.ACCOUNTS]).length>0)return void t(!1);const a=n.buzzchatSettings,s=this.createDefaultAccount("default","Default");a&&(s.settings=this.deepMerge(s.settings,a)),e.storage.sync.set({[this.STORAGE_KEYS.ACCOUNTS]:{default:s},[this.STORAGE_KEYS.ACTIVE_ID]:"default"},()=>t(!0))})})},async getAccountList(){const e=await this.getAccounts(),t=await this.getActiveAccountId();return Object.values(e).map(e=>({id:e.id,name:e.name,createdAt:e.createdAt,isActive:e.id===t})).sort((e,t)=>"default"===e.id?-1:"default"===t.id?1:e.createdAt-t.createdAt)},deepMerge(e,t){if(!t||"object"!=typeof t)return e;if(!e||"object"!=typeof e)return t;const n={...e};for(const e in t){const a=t[e],s=n[e];a&&"object"==typeof a&&!Array.isArray(a)&&s&&"object"==typeof s&&!Array.isArray(s)?n[e]=this.deepMerge(s,a):void 0!==a&&(n[e]=a)}return n}},A={container:null,init(){this.container||(this.container=document.createElement("div"),this.container.className="toast-container",this.container.setAttribute("role","status"),this.container.setAttribute("aria-live","polite"),document.body.appendChild(this.container))},show(e,t="info",n=3e3){this.init();const a=document.createElement("div");a.className=`toast toast-${t}`,a.setAttribute("role","alert");const s={success:"‚úì",error:"‚úï",info:"‚Ñπ",warning:"‚ö†"},i=document.createElement("span");i.className="toast-icon",i.textContent=s[t]||s.info;const o=document.createElement("span");return o.className="toast-message",o.textContent=e,a.appendChild(i),a.appendChild(o),this.container.appendChild(a),setTimeout(()=>{a.classList.add("toast-exit"),setTimeout(()=>a.remove(),300)},n),a},success(e){return this.show(e,"success")},error(e){return this.show(e,"error")},info(e){return this.show(e,"info")},warning(e){return this.show(e,"warning")},showWithAction(e,t,n,a=5e3){this.init();const s=document.createElement("div");s.className=`toast toast-${t} toast-with-action`,s.setAttribute("role","alert");const i={success:"‚úì",error:"‚úï",info:"‚Ñπ",warning:"‚ö†"},o=document.createElement("span");o.className="toast-icon",o.textContent=i[t]||i.info;const r=document.createElement("div");r.className="toast-content";const c=document.createElement("span");if(c.className="toast-message",c.textContent=e,r.appendChild(c),n&&n.label&&n.onClick){const e=document.createElement("button");e.className="toast-action",e.textContent=n.label,e.addEventListener("click",()=>{n.onClick(),s.remove()}),r.appendChild(e)}return s.appendChild(o),s.appendChild(r),this.container.appendChild(s),a>0&&setTimeout(()=>{s.classList.add("toast-exit"),setTimeout(()=>s.remove(),300)},a),s}},k={element:null,timeout:null,init(){this.element=document.getElementById("saveIndicator")},show(){this.element||this.init(),this.element&&(this.timeout&&clearTimeout(this.timeout),this.element.classList.add("visible"),this.timeout=setTimeout(()=>{this.element.classList.remove("visible")},2e3))}},T={show(e){e&&(e.classList.add("loading"),e.disabled=!0)},hide(e){e&&(e.classList.remove("loading"),e.disabled=!1)}};async function S(){await C.migrateFromLegacy();const t=await C.getActiveSettings();return t?(p({...g,...t}),void w(!0)):new Promise(t=>{e.storage.sync.get(["buzzchatSettings"],n=>{if(e.runtime.lastError)return console.error("[BuzzChat] Failed to load settings:",e.runtime.lastError),void t();n.buzzchatSettings&&p({...g,...n.buzzchatSettings}),t()})})}async function M(t=!1){const{useAccountManager:n}=await Promise.resolve().then(function(){return b}),a=(await Promise.resolve().then(function(){return b})).settings;if(n)try{return await C.updateActiveSettings(a),e.tabs.query({active:!0,currentWindow:!0},t=>{t[0]?.id&&e.tabs.sendMessage(t[0].id,{type:"SETTINGS_UPDATED",settings:a}).catch(()=>{})}),k.show(),void(t&&A.success("Settings saved"))}catch(e){return console.error("[BuzzChat] Failed to save settings:",e),void A.error("Failed to save settings")}return new Promise(n=>{e.storage.sync.set({buzzchatSettings:a},()=>{if(e.runtime.lastError)return console.error("[BuzzChat] Failed to save settings:",e.runtime.lastError),A.error("Failed to save settings"),void n();e.tabs.query({active:!0,currentWindow:!0},t=>{t[0]?.id&&e.tabs.sendMessage(t[0].id,{type:"SETTINGS_UPDATED",settings:a}).catch(()=>{})}),k.show(),t&&A.success("Settings saved"),n()})})}async function L(t,n={}){return new Promise(a=>{e.tabs.query({active:!0,currentWindow:!0},s=>{s[0]?.id?e.tabs.sendMessage(s[0].id,{type:t,...n}).then(()=>a(!0)).catch(()=>{A.error("Please navigate to a live stream first"),a(!1)}):(A.error("No active tab found"),a(!1))})})}function I(e,t){let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e(...a),t)}}function x(e,n=t){if(!e)return"";const a=e.trim();return a.length>n?(A.warning(`Text truncated to ${n} characters`),a.substring(0,n)):a}function q(e,t,n,a){const s=parseInt(e,10);return isNaN(s)?a:Math.min(Math.max(s,t),n)}function R(e){return e&&"string"==typeof e?String(e).slice(0,50).replace(/[^a-zA-Z0-9_\- ]/g,""):""}function P(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}const N={activeModal:null,previouslyFocusedElement:null,activate(e){this.activeModal=e,this.previouslyFocusedElement=document.activeElement;const t=this.getFocusableElements(e);t.length>0&&t[0].focus(),document.addEventListener("keydown",this.handleKeyDown)},deactivate(){document.removeEventListener("keydown",this.handleKeyDown),this.previouslyFocusedElement&&this.previouslyFocusedElement.focus(),this.activeModal=null,this.previouslyFocusedElement=null},getFocusableElements:e=>Array.from(e.querySelectorAll(["button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])","a[href]",'[tabindex]:not([tabindex="-1"])'].join(", "))),handleKeyDown:function(e){if(N.activeModal){if("Escape"===e.key)return N.activeModal.classList.remove("active"),void N.deactivate();if("Tab"===e.key){const t=N.getFocusableElements(N.activeModal);if(0===t.length)return;const n=t[0],a=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),a.focus()):e.shiftKey||document.activeElement!==a||(e.preventDefault(),n.focus())}}}};function K(e){e&&(e.classList.add("active"),N.activate(e))}function _(e){e&&(e.classList.remove("active"),N.deactivate())}function O(e){e&&e.addEventListener("click",t=>{t.target===e&&_(e)})}const $={masterToggle:null,statusBadge:null,tierBanner:null,welcomeToggle:null,welcomeMessage:null,welcomeDelay:null,timerToggle:null,timerMessages:null,addTimerBtn:null,timerMessageTemplate:null,faqToggle:null,faqItems:null,addFaqBtn:null,faqTemplate:null,templatesList:null,addTemplateBtn:null,templateTemplate:null,settingsModal:null,settingsBtn:null,closeSettingsBtn:null,upgradeModal:null,upgradeBtn:null,closeUpgradeBtn:null,helpModal:null,helpBtn:null,closeHelpBtn:null,chatSelector:null,soundNotifications:null,showMessageCount:null,darkModeToggle:null,exportSettingsBtn:null,importSettingsBtn:null,importFile:null,subscribePro:null,subscribeBusiness:null,startTrialBtn:null,trialBanner:null,annualBillingToggle:null,proPrice:null,proPriceAnnual:null,proPriceNote:null,businessPrice:null,businessPriceAnnual:null,businessPriceNote:null,watermarkToggle:null,onboardingModal:null,acceptTerms:null,onboardingPrevBtn:null,onboardingNextBtn:null,onboardingMessage:null,messagePreview:null,setupWelcome:null,setupTimer:null,setupFaq:null,saveIndicator:null,moderationToggle:null,blockedWords:null,blockRepeatedToggle:null,maxRepeatCount:null,giveawayToggle:null,giveawayKeywords:null,giveawayUniqueToggle:null,giveawayEntryCount:null,giveawayEntriesList:null,refreshGiveawayBtn:null,resetGiveawayBtn:null,metricMessagesPerMin:null,metricUniqueChatters:null,metricPeakMsgs:null,refreshMetricsBtn:null,analyticsLocked:null,analyticsContent:null,unlockAnalyticsBtn:null,exportAnalyticsBtn:null,statTotalMessages:null,statTodayMessages:null,statPeakHour:null,weeklyChart:null,typePieChart:null,legendWelcome:null,legendFaq:null,legendTimer:null,legendTemplate:null,faqTriggersList:null,referralCode:null,copyReferralBtn:null,referralCount:null,referralBonus:null,redeemCode:null,redeemCodeBtn:null,referralRedeemedMsg:null,accountSelectorContainer:null,accountSelect:null,newAccountBtn:null,manageAccountsBtn:null,accountManagerModal:null,closeAccountManagerBtn:null,accountsList:null,createAccountModalBtn:null,createAccountForm:null,newAccountName:null,confirmCreateAccountBtn:null,cancelCreateAccountBtn:null,apiSection:null,apiLocked:null,apiKeysList:null,emptyKeysMessage:null,createApiKeyBtn:null,apiKeyCreated:null,newApiKeyValue:null,copyNewApiKeyBtn:null,closeApiKeyCreatedBtn:null,unlockApiBtn:null,commandsToggle:null,commandsList:null,addCommandBtn:null,commandTemplate:null,exportCommandsBtn:null,importCommandsBtn:null,importCommandsFile:null,spinWheelBtn:null,winnerCount:null,winnerDisplay:null,winnerNames:null,announceWinnerBtn:null,rerollWinnerBtn:null,closeWinnerBtn:null,wheelOverlay:null,spinningWheel:null,wheelStatus:null,confettiCanvas:null,quickReplyToggle:null,quickReplyPosition:null,quickReplyButtonsList:null,addQuickReplyBtn:null,quickReplyTemplate:null};function D(e){("auto"===e||void 0===e?window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches:e)?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme")}function z(){y.masterEnabled?($.statusBadge.classList.add("active"),$.statusBadge.querySelector(".status-text").textContent="Active"):($.statusBadge.classList.remove("active"),$.statusBadge.querySelector(".status-text").textContent="Inactive")}async function F(){const e=$.tierBanner.querySelector(".tier-label"),t=$.tierBanner.querySelector(".tier-usage"),n=document.getElementById("vipBadge"),a=n?.querySelector(".vip-tier-text"),i=document.getElementById("memberSince");if($.tierBanner.classList.remove("pro","vip-pro","vip-business"),"pro"===y.tier||"business"===y.tier){const s="business"===y.tier?"vip-business":"vip-pro";if($.tierBanner.classList.add(s),n){n.style.display="inline-flex",a&&(a.textContent="business"===y.tier?"MAX":"PRO");const e=n.querySelector(".vip-icon");e&&"business"===y.tier&&(e.innerHTML='<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>')}if(i&&y.memberSince){const e=new Date(y.memberSince),t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];i.textContent=`Member since ${t[e.getMonth()]} ${e.getFullYear()}`,i.style.display="inline"}else i&&(y.memberSince||(y.memberSince=(new Date).toISOString(),M()),i.style.display="none");e.textContent="business"===y.tier?"Max":"Pro",t.textContent="Unlimited features + Analytics"}else{n&&(n.style.display="none"),i&&(i.style.display="none"),e.textContent="Free Plan";const a=y.faq?.rules?.length||0,r=y.commands?.list?.length||0,c=s,l=o;t.textContent=a>=c||r>=l?"Upgrade to Pro for unlimited rules & analytics":`${c-a} FAQ rules, ${l-r} commands left`}}function W(e){let t,r,c;const l="pro"===y.tier||"business"===y.tier;switch(e){case"timer":t=y.timer.messages.length,r=n,c="timer messages";break;case"faq":t=y.faq.rules.length,r=l?a:s,c="FAQ rules";break;case"command":t=y.commands?.list?.length||0,r=l?i:o,c="commands";break;case"template":t=y.templates.length,r=u,c="templates";break;default:return!0}return!(t>=r)||("faq"!==e&&"command"!==e||l?A.warning(`Maximum of ${r} ${c} reached`):A.warning(`Free plan allows ${r} ${c}. Upgrade to Pro for unlimited!`),F(),!1)}function U(){if($.timerMessages.innerHTML="",0===y.timer.messages.length){const e=document.createElement("div");return e.className="empty-state",e.innerHTML='\n      <div class="empty-state-icon">‚è∞</div>\n      <h4>No Timer Messages Yet</h4>\n      <p>Add timed promotions that repeat during your stream</p>\n      <button class="btn btn-primary empty-state-cta">Add Your First Timer</button>\n    ',e.querySelector(".empty-state-cta").addEventListener("click",()=>{W("timer")&&j()}),void $.timerMessages.appendChild(e)}y.timer.messages.forEach((e,t)=>{const n=function(e,t){const n=$.timerMessageTemplate.content.cloneNode(!0).querySelector(".timer-message-item"),a=n.querySelector(".timer-text"),s=n.querySelector(".timer-interval"),i=n.querySelector(".remove-timer-btn");return a.value=e.text||"",s.value=e.interval||5,a.addEventListener("input",I(async()=>{y.timer.messages[t].text=x(a.value),await M()},500)),s.addEventListener("change",async()=>{const e=q(s.value,r,c,5);y.timer.messages[t].interval=e,s.value=e,await M()}),i.addEventListener("click",async()=>{confirm("Delete this timer message? This cannot be undone.")&&(y.timer.messages.splice(t,1),U(),await M(),A.success("Timer message deleted"))}),n}(e,t);$.timerMessages.appendChild(n)})}function j(){W("timer")&&(y.timer.messages.push({text:"",interval:5}),U(),M())}function Y(){if($.faqItems.innerHTML="",0===y.faq.rules.length){const e=document.createElement("div");return e.className="empty-state",e.innerHTML='\n      <div class="empty-state-icon">‚ùì</div>\n      <h4>No FAQ Rules Yet</h4>\n      <p>Auto-reply to common questions like "shipping?" or "payment?"</p>\n      <button class="btn btn-primary empty-state-cta">Add Your First FAQ</button>\n    ',e.querySelector(".empty-state-cta").addEventListener("click",()=>{W("faq")&&G()}),void $.faqItems.appendChild(e)}y.faq.rules.forEach((e,t)=>{const n=function(e,t){const n=$.faqTemplate.content.cloneNode(!0).querySelector(".faq-item"),a=n.querySelector(".faq-triggers"),s=n.querySelector(".faq-reply"),i=n.querySelector(".faq-case-sensitive"),o=n.querySelector(".remove-faq-btn");return a.value=e.triggers?.join(", ")||"",s.value=e.reply||"",i.checked=e.caseSensitive||!1,a.addEventListener("input",I(async()=>{let e=a.value.split(",").map(e=>e.trim()).filter(e=>e);e.length>m&&(e=e.slice(0,m),A.warning(`Maximum of ${m} triggers per rule`)),y.faq.rules[t].triggers=e,await M()},500)),s.addEventListener("input",I(async()=>{y.faq.rules[t].reply=x(s.value),await M()},500)),i.addEventListener("change",async()=>{y.faq.rules[t].caseSensitive=i.checked,await M()}),o.addEventListener("click",async()=>{confirm("Delete this FAQ rule? This cannot be undone.")&&(y.faq.rules.splice(t,1),Y(),await M(),A.success("FAQ rule deleted"))}),n}(e,t);$.faqItems.appendChild(n)})}function G(){W("faq")&&(y.faq.rules.push({triggers:[],reply:"",caseSensitive:!1}),Y(),M())}function H(){if($.templatesList.innerHTML="",0===y.templates.length){const e=document.createElement("div");return e.className="empty-state",e.innerHTML='\n      <div class="empty-state-icon">üìù</div>\n      <h4>No Templates Yet</h4>\n      <p>Save frequently used messages for quick sending</p>\n      <button class="btn btn-primary empty-state-cta">Add Your First Template</button>\n    ',e.querySelector(".empty-state-cta").addEventListener("click",()=>{W("template")&&V()}),void $.templatesList.appendChild(e)}y.templates.forEach((e,t)=>{const n=function(e,t){const n=$.templateTemplate.content.cloneNode(!0).querySelector(".template-item"),a=n.querySelector(".template-name"),s=n.querySelector(".template-text"),i=n.querySelector(".send-template-btn"),o=n.querySelector(".remove-template-btn");return a.value=e.name||"",s.value=e.text||"",a.addEventListener("input",I(async()=>{y.templates[t].name=x(a.value,50),await M()},500)),s.addEventListener("input",I(async()=>{y.templates[t].text=x(s.value),await M()},500)),i.addEventListener("click",async()=>{if(!s.value.trim())return void A.warning("Template is empty");T.show(i);const e=await L("SEND_TEMPLATE",{text:s.value});T.hide(i),e&&A.success("Template sent")}),o.addEventListener("click",async()=>{confirm("Delete this template? This cannot be undone.")&&(y.templates.splice(t,1),H(),await M(),A.success("Template deleted"))}),n}(e,t);$.templatesList.appendChild(n)})}function V(){W("template")&&(y.templates.push({name:"",text:""}),H(),M())}function Q(){if(!$.commandsList)return;$.commandsList.innerHTML="";const e=y.commands?.list||[];if(0===e.length){const e=document.createElement("div");return e.className="empty-state",e.innerHTML='\n      <div class="empty-state-icon">‚å®Ô∏è</div>\n      <h4>No Commands Yet</h4>\n      <p>Create chat commands like !shipping or !payment</p>\n      <button class="btn btn-primary empty-state-cta">Add Your First Command</button>\n    ',e.querySelector(".empty-state-cta").addEventListener("click",()=>{W("command")&&X()}),void $.commandsList.appendChild(e)}e.forEach((e,t)=>{const n=function(e,t){const n=$.commandTemplate.content.cloneNode(!0).querySelector(".command-item"),a=n.querySelector(".command-trigger"),s=n.querySelector(".command-response"),i=n.querySelector(".command-cooldown"),o=n.querySelector(".command-usage-count"),r=n.querySelector(".remove-command-btn");return a.value=e.trigger||"",s.value=e.response||"",i.value=e.cooldown||30,o.textContent=`${e.usageCount||0} uses`,a.addEventListener("input",I(async()=>{let e=a.value.replace(/^!+/,"").toLowerCase();e=e.replace(/[^a-z0-9_]/g,""),a.value=e,y.commands.list[t].trigger=e,await M()},500)),s.addEventListener("input",I(async()=>{y.commands.list[t].response=x(s.value),await M()},500)),i.addEventListener("change",async()=>{const e=q(i.value,0,300,30);y.commands.list[t].cooldown=e,i.value=e,await M()}),r.addEventListener("click",async()=>{confirm("Delete this command? This cannot be undone.")&&(y.commands.list.splice(t,1),Q(),await M(),A.success("Command deleted"))}),n}(e,t);$.commandsList.appendChild(n)})}function X(){W("command")&&(y.commands||(y.commands={enabled:!1,list:[]}),y.commands.list.push({trigger:"",response:"",cooldown:30,usageCount:0}),Q(),M())}function J(){const e=y.commands?.list||[];if(0!==e.length)try{const t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download="buzzchat-commands.json",s.click(),URL.revokeObjectURL(a),A.success("Commands exported")}catch(e){A.error("Export failed")}else A.warning("No commands to export")}async function Z(e){const t=e.target.files[0];if(t){try{const n=await t.text(),a=JSON.parse(n);if(!Array.isArray(a))return A.error("Invalid commands file format"),void(e.target.value="");const s=a.filter(e=>e&&"object"==typeof e).map(e=>({trigger:String(e.trigger||"").replace(/^!+/,"").toLowerCase().replace(/[^a-z0-9_]/g,"").slice(0,20),response:String(e.response||"").slice(0,500),cooldown:Math.min(300,Math.max(0,parseInt(e.cooldown)||30)),usageCount:0})).filter(e=>e.trigger&&e.response);if(0===s.length)return A.error("No valid commands found in file"),void(e.target.value="");y.commands||(y.commands={enabled:!1,list:[]}),y.commands.list=[...y.commands.list,...s],await M(),Q(),A.success(`Imported ${s.length} commands`)}catch(e){A.error("Failed to parse commands file")}e.target.value=""}}function ee(){if(!$.quickReplyButtonsList)return;$.quickReplyButtonsList.innerHTML="";const e=y.quickReply?.buttons||[];if(0===e.length){const e=document.createElement("p");return e.className="help-text",e.textContent="No buttons configured. Add some quick reply buttons!",void $.quickReplyButtonsList.appendChild(e)}e.forEach((e,t)=>{const n=function(e,t){const n=$.quickReplyTemplate.content.cloneNode(!0).querySelector(".quick-reply-edit-item"),a=n.querySelector(".quick-reply-emoji-input"),s=n.querySelector(".quick-reply-text-input"),i=n.querySelector(".remove-quick-reply-btn");return a.value=e.emoji||"",s.value=e.text||"",a.addEventListener("input",I(async()=>{const e=/^[\p{Emoji}\p{Emoji_Component}\p{Emoji_Modifier}\p{Emoji_Presentation}]*$/u;let n=a.value.slice(0,2);if(n&&!e.test(n)){const e=n.match(/[\p{Emoji}\p{Emoji_Presentation}]/gu);n=e?e.slice(0,1).join(""):"",a.value=n}y.quickReply.buttons[t].emoji=n,await M()},500)),s.addEventListener("input",I(async()=>{y.quickReply.buttons[t].text=s.value.slice(0,100),await M()},500)),i.addEventListener("click",async()=>{y.quickReply.buttons.splice(t,1),ee(),await M(),A.success("Button removed")}),n}(e,t);$.quickReplyButtonsList.appendChild(n)})}function te(){y.quickReply||(y.quickReply={enabled:!0,minimized:!1,buttons:[]}),y.quickReply.buttons.length>=10?A.warning("Maximum of 10 quick reply buttons"):(y.quickReply.buttons.push({text:"",emoji:""}),ee(),M())}async function ne(){if(!$.spinWheelBtn?.classList.contains("loading")){T.show($.spinWheelBtn);try{const e=await L("GET_GIVEAWAY_ENTRIES");if(!e||!e.entries||0===e.entries.length)return A.warning("No entries yet! Wait for viewers to enter."),void T.hide($.spinWheelBtn);B(e.entries.slice(0,1e3).map(e=>e.username));const t=Math.max(1,Math.min(10,parseInt($.winnerCount?.value||"1")));if(f.length<t)return A.warning(`Only ${f.length} entries. Need at least ${t} to pick ${t} winner(s).`),void T.hide($.spinWheelBtn);"pro"===y.tier||"business"===y.tier?(!function(e){if(!$.wheelOverlay||!$.spinningWheel)return;const t=e.slice(0,12),n=360/t.length;$.spinningWheel.innerHTML="",$.spinningWheel.style.transform="rotate(0deg)",t.forEach((e,t)=>{const a=document.createElement("div");a.className="wheel-segment",a.style.transform=`rotate(${t*n-90}deg) skewY(${90-n}deg)`;const s=document.createElement("div");s.className="wheel-segment-inner",s.style.transform=`skewY(${n-90}deg)`;const i=document.createElement("span");i.textContent=e.slice(0,10),s.appendChild(i),a.appendChild(s),$.spinningWheel.appendChild(a)}),$.wheelStatus.textContent="Spinning...",$.wheelOverlay.classList.add("active"),$.wheelOverlay.setAttribute("aria-busy","true")}(f),await async function(e,t){return new Promise(n=>{E([...e].sort(()=>Math.random()-.5).slice(0,t));const a=360*(5+3*Math.random())+360*Math.random();$.spinningWheel&&($.spinningWheel.style.transition="transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)",$.spinningWheel.style.transform=`rotate(${a}deg)`),setTimeout(()=>{$.wheelOverlay&&($.wheelOverlay.classList.remove("active"),$.wheelOverlay.setAttribute("aria-busy","false")),ae(v),oe(),n()},4200)})}(f,t)):await async function(e,t){return new Promise(n=>{E([...e].sort(()=>Math.random()-.5).slice(0,t)),setTimeout(()=>{ae(v),A.info("Upgrade to Pro for the animated spinner wheel!"),n()},500)})}(f,t)}finally{T.hide($.spinWheelBtn)}}}function ae(e){if(!$.winnerDisplay||!$.winnerNames)return;$.winnerNames.innerHTML="";const t=$.winnerDisplay.querySelector(".winner-title");t&&(t.textContent=e.length>1?"Winners!":"Winner!"),e.forEach(e=>{const t=document.createElement("div");t.className="winner-name",t.textContent=e,$.winnerNames.appendChild(t)}),$.winnerDisplay.style.display="flex"}function se(){$.winnerDisplay&&($.winnerDisplay.style.display="none")}async function ie(){if(0!==v.length){T.show($.announceWinnerBtn);try{const e=v.join(", "),t=v.length>1?`üéâ GIVEAWAY WINNERS: ${e}! Congratulations! üéâ`:`üéâ GIVEAWAY WINNER: ${e}! Congratulations! üéâ`;await L("SEND_TEMPLATE",{text:t})&&A.success("Winners announced in chat!")}finally{T.hide($.announceWinnerBtn)}}}function oe(){const e=$.confettiCanvas;if(!e)return;const t=e.getContext("2d");e.width=Math.min(window.innerWidth,1920),e.height=Math.min(window.innerHeight,1080);const n=[],a=getComputedStyle(document.documentElement),s=[a.getPropertyValue("--confetti-1").trim()||"#e74c3c",a.getPropertyValue("--confetti-2").trim()||"#3498db",a.getPropertyValue("--confetti-3").trim()||"#2ecc71",a.getPropertyValue("--confetti-4").trim()||"#f39c12",a.getPropertyValue("--confetti-5").trim()||"#9b59b6",a.getPropertyValue("--confetti-6").trim()||"#1abc9c",a.getPropertyValue("--confetti-7").trim()||"#e91e63",a.getPropertyValue("--confetti-8").trim()||"#00bcd4"];for(let t=0;t<150;t++)n.push({x:Math.random()*e.width,y:-20,size:10*Math.random()+5,color:s[Math.floor(Math.random()*s.length)],speedY:3*Math.random()+2,speedX:4*(Math.random()-.5),rotation:360*Math.random(),rotationSpeed:10*(Math.random()-.5)});let i;const o=()=>{t.clearRect(0,0,e.width,e.height);let a=0;n.forEach(n=>{n.y<e.height+20&&(a++,n.y+=n.speedY,n.x+=n.speedX,n.rotation+=n.rotationSpeed,t.save(),t.translate(n.x,n.y),t.rotate(n.rotation*Math.PI/180),t.fillStyle=n.color,t.fillRect(-n.size/2,-n.size/2,n.size,.6*n.size),t.restore())}),a>0?i=requestAnimationFrame(o):t.clearRect(0,0,e.width,e.height)};o(),setTimeout(()=>{i&&cancelAnimationFrame(i),t.clearRect(0,0,e.width,e.height)},5e3)}async function re(){try{const t=await new Promise(t=>{e.tabs.query({active:!0,currentWindow:!0},n=>{n[0]?.id?e.tabs.sendMessage(n[0].id,{type:"GET_GIVEAWAY_ENTRIES"}).then(t).catch(()=>t({success:!1})):t({success:!1})})});if(t?.success&&($.giveawayEntryCount&&($.giveawayEntryCount.textContent=t.totalEntries||0),$.giveawayEntriesList)){for(;$.giveawayEntriesList.firstChild;)$.giveawayEntriesList.removeChild($.giveawayEntriesList.firstChild);if(t.entries&&t.entries.length>0){const e=t.entries.sort((e,t)=>t.timestamp-e.timestamp).slice(0,20);for(const t of e){const e=document.createElement("div");e.className="entry-item";const n=document.createElement("span");n.className="entry-username",n.textContent=R(t.username);const a=document.createElement("span");a.className="entry-time",a.textContent=P(t.timestamp),e.appendChild(n),e.appendChild(a),$.giveawayEntriesList.appendChild(e)}}else{const e=document.createElement("p");e.className="empty-entries",e.textContent="No entries yet. Entries will appear here when viewers type your keywords.",$.giveawayEntriesList.appendChild(e)}}}catch(e){console.error("[BuzzChat] Failed to load giveaway data:",e)}}async function ce(){try{const t=await new Promise(t=>{e.tabs.query({active:!0,currentWindow:!0},n=>{n[0]?.id?e.tabs.sendMessage(n[0].id,{type:"GET_CHAT_METRICS"}).then(t).catch(()=>t({success:!1})):t({success:!1})})});t?.success&&t.metrics&&le(t.metrics)}catch(e){console.error("[BuzzChat] Failed to load chat metrics:",e)}}function le(e){$.metricMessagesPerMin&&($.metricMessagesPerMin.textContent=e.messagesPerMinute||0),$.metricUniqueChatters&&($.metricUniqueChatters.textContent=e.uniqueChatters||0),$.metricPeakMsgs&&($.metricPeakMsgs.textContent=e.peakMessagesPerMinute||0)}const de={STORAGE_KEY:"buzzchatAnalytics",getDefaultData:()=>({totalMessagesSent:0,welcomeMessagesSent:0,faqRepliesSent:0,timerMessagesSent:0,templatesSent:0,sessionsCount:0,lastSessionDate:null,dailyStats:{},hourlyActivity:new Array(24).fill(0),topFaqTriggers:{},milestonesAchieved:[]}),async load(){return new Promise(t=>{e.storage.local.get([this.STORAGE_KEY],e=>{t(e[this.STORAGE_KEY]||this.getDefaultData())})})},getTodayKey:()=>(new Date).toISOString().split("T")[0],async getSummary(){const e=await this.load(),t=this.getTodayKey(),n=e.dailyStats[t]||{messages:0},a=[];for(let t=6;t>=0;t--){const n=new Date;n.setDate(n.getDate()-t);const s=n.toISOString().split("T")[0];a.push({date:s,label:n.toLocaleDateString("en-US",{weekday:"short"}),...e.dailyStats[s]||{messages:0,welcomes:0,faqs:0,timers:0,templates:0}})}const s=Object.entries(e.topFaqTriggers).sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e,t])=>({trigger:e,count:t})),i=e.hourlyActivity.indexOf(Math.max(...e.hourlyActivity)),o=0===i?"12 AM":i<12?`${i} AM`:12===i?"12 PM":i-12+" PM";return{totalMessages:e.totalMessagesSent,todayMessages:n.messages,welcomesSent:e.welcomeMessagesSent,faqReplies:e.faqRepliesSent,timerMessages:e.timerMessagesSent,templatesSent:e.templatesSent,sessionsCount:e.sessionsCount,last7Days:a,hourlyActivity:e.hourlyActivity,topTriggers:s,peakHour:o}},generateWeeklyChart(e,t=300,n=100){const a=Math.max(...e.map(e=>e.messages),1),s=(t-60)/7,i=e.map((e,t)=>{const i=e.messages/a*(n-30),o=30+t*s+.1*s,r=n-20-i;return`\n        <rect x="${o}" y="${r}" width="${.8*s}" height="${i}"\n              fill="#7c3aed" rx="2"/>\n        <text x="${o+.4*s}" y="${n-5}"\n              text-anchor="middle" font-size="10" fill="currentColor">${e.label}</text>\n        <text x="${o+.4*s}" y="${r-5}"\n              text-anchor="middle" font-size="9" fill="currentColor">${e.messages||""}</text>\n      `}).join("");return`\n      <svg width="${t}" height="${n}" viewBox="0 0 ${t} ${n}">\n        <line x1="30" y1="0" x2="30" y2="${n-20}" stroke="currentColor" stroke-opacity="0.2" stroke-width="1"/>\n        <line x1="30" y1="${n-20}" x2="${t}" y2="${n-20}" stroke="currentColor" stroke-opacity="0.2" stroke-width="1"/>\n        ${i}\n      </svg>\n    `},generateTypePieChart(e,t=120){const n=e.welcomesSent+e.faqReplies+e.timerMessages+e.templatesSent;if(0===n)return`\n        <svg width="${t}" height="${t}" viewBox="0 0 ${t} ${t}">\n          <circle cx="${t/2}" cy="${t/2}" r="${t/2-10}" fill="#e5e7eb"/>\n          <text x="${t/2}" y="${t/2}" text-anchor="middle" dy="4" font-size="12" fill="#6b7280">No data</text>\n        </svg>\n      `;const a=t/2,s=t/2,i=t/2-10,o=[{value:e.welcomesSent,color:"#10b981",label:"Welcome"},{value:e.faqReplies,color:"#f59e0b",label:"FAQ"},{value:e.timerMessages,color:"#7c3aed",label:"Timer"},{value:e.templatesSent,color:"#3b82f6",label:"Template"}].filter(e=>e.value>0);let r=-90;return`\n      <svg width="${t}" height="${t}" viewBox="0 0 ${t} ${t}">\n        ${o.map(e=>{const t=e.value/n*360,o=r,c=r+t,l=a+i*Math.cos(o*Math.PI/180),d=s+i*Math.sin(o*Math.PI/180),u=a+i*Math.cos(c*Math.PI/180),m=s+i*Math.sin(c*Math.PI/180);return r=c,`<path d="M ${a} ${s} L ${l} ${d} A ${i} ${i} 0 ${t>180?1:0} 1 ${u} ${m} Z"\n                    fill="${e.color}"/>`}).join("")}\n      </svg>\n    `},async exportCSV(){const e=await this.load(),t=[["Date","Messages","Welcomes","FAQs","Timers","Templates"]];Object.entries(e.dailyStats).sort((e,t)=>e[0].localeCompare(t[0])).forEach(([e,n])=>{t.push([e,n.messages,n.welcomes,n.faqs,n.timers,n.templates||0])});const n=t.map(e=>e.join(",")).join("\n"),a=new Blob([n],{type:"text/csv"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download=`buzzchat-analytics-${this.getTodayKey()}.csv`,i.click(),URL.revokeObjectURL(s)},async checkMilestones(){const t=await this.load(),n=[{id:"messages_1000",type:"messages",value:1e3,title:"üéâ",message:"1,000 messages sent!"},{id:"messages_5000",type:"messages",value:5e3,title:"üöÄ",message:"5,000 messages sent!"},{id:"messages_10000",type:"messages",value:1e4,title:"‚≠ê",message:"10,000 messages sent!"},{id:"welcomes_100",type:"welcomes",value:100,title:"üëã",message:"100 viewers welcomed!"},{id:"welcomes_500",type:"welcomes",value:500,title:"üåü",message:"500 viewers welcomed!"},{id:"faq_100",type:"faq",value:100,title:"‚ùì",message:"100 FAQ replies sent!"}],a=[],s=t.milestonesAchieved||[];for(const e of n){if(s.includes(e.id))continue;let n=0;switch(e.type){case"messages":n=t.totalMessagesSent;break;case"welcomes":n=t.welcomeMessagesSent;break;case"faq":n=t.faqRepliesSent}n>=e.value&&(a.push(e),s.push(e.id))}return a.length>0&&(t.milestonesAchieved=s,await new Promise(n=>{e.storage.local.set({[this.STORAGE_KEY]:t},n)})),a},async getImpactSummary(){const e=await this.load(),t=5*e.totalMessagesSent,n=t/3600;return{viewersEngaged:e.welcomeMessagesSent,hoursSaved:n>=1?n.toFixed(1):(t/60).toFixed(0),hoursSavedUnit:n>=1?"Hours":"Minutes",questionsAnswered:e.faqRepliesSent,growthPercent:0,isGrowing:!0}}};async function ue(){const e="pro"===y.tier||"business"===y.tier;$.analyticsLocked&&$.analyticsContent&&($.analyticsLocked.style.display="none",$.analyticsContent.style.display="block",await async function(){try{const e=await de.getSummary();if($.statTotalMessages&&($.statTotalMessages.textContent=e.totalMessages.toLocaleString()),$.statTodayMessages&&($.statTodayMessages.textContent=e.todayMessages.toLocaleString()),$.statPeakHour&&($.statPeakHour.textContent=e.totalMessages>0?e.peakHour:"--"),$.weeklyChart&&($.weeklyChart.innerHTML=de.generateWeeklyChart(e.last7Days)),$.typePieChart&&($.typePieChart.innerHTML=de.generateTypePieChart(e)),$.legendWelcome&&($.legendWelcome.textContent=e.welcomesSent),$.legendFaq&&($.legendFaq.textContent=e.faqReplies),$.legendTimer&&($.legendTimer.textContent=e.timerMessages),$.legendTemplate&&($.legendTemplate.textContent=e.templatesSent),$.faqTriggersList){for(;$.faqTriggersList.firstChild;)$.faqTriggersList.removeChild($.faqTriggersList.firstChild);if(e.topTriggers.length>0)e.topTriggers.forEach(e=>{const t=document.createElement("div");t.className="trigger-item";const n=document.createElement("span");n.className="trigger-keyword",n.textContent=e.trigger;const a=document.createElement("span");a.className="trigger-count",a.textContent=e.count,t.appendChild(n),t.appendChild(a),$.faqTriggersList.appendChild(t)});else{const e=document.createElement("p");e.className="empty-triggers",e.textContent="No FAQ triggers yet",$.faqTriggersList.appendChild(e)}}await async function(){const e="pro"===y.tier||"business"===y.tier,t=document.getElementById("impactSummary");if(!t)return;if(!e)return void(t.style.display="none");t.style.display="block";try{const e=await de.getImpactSummary(),t=document.getElementById("impactViewers"),n=document.getElementById("impactTimeSaved"),a=document.getElementById("impactTimeLabel"),s=document.getElementById("impactQuestions"),i=document.getElementById("impactGrowth");t&&(t.textContent=e.viewersEngaged.toLocaleString()),n&&(n.textContent=e.hoursSaved),a&&(a.textContent=`${e.hoursSavedUnit} Saved`),s&&(s.textContent=e.questionsAnswered.toLocaleString()),i&&0!==e.growthPercent?(i.style.display="inline",i.className="impact-growth "+(e.isGrowing?"positive":"negative"),i.textContent=`${e.isGrowing?"+":""}${e.growthPercent}% vs last month`):i&&(i.style.display="none")}catch(e){console.error("[BuzzChat] Failed to load impact summary:",e)}}()}catch(e){console.error("[BuzzChat] Failed to load analytics data:",e)}}(),$.exportAnalyticsBtn&&($.exportAnalyticsBtn.style.display=e?"inline-flex":"none"))}const me={STORAGE_KEY:"buzzchatApiKeys",KEY_PREFIX:"bz_live_",MAX_KEYS:5,generateKey(){const e=crypto.randomUUID().replace(/-/g,""),t=crypto.randomUUID().replace(/-/g,"").slice(0,16);return this.KEY_PREFIX+e+t},generateKeyId:()=>"key_"+crypto.randomUUID().slice(0,8),async getKeys(){return new Promise(t=>{e.storage.sync.get([this.STORAGE_KEY],e=>{t(e[this.STORAGE_KEY]||{})})})},async createKey(t){const n=await this.getKeys();if(Object.keys(n).length>=this.MAX_KEYS)throw new Error(`Maximum of ${this.MAX_KEYS} API keys reached`);const a=(t||"").trim().slice(0,50);if(!a)throw new Error("API key name cannot be empty");const s=this.generateKeyId(),i={id:s,name:a,key:this.generateKey(),createdAt:Date.now(),lastUsed:null};return n[s]=i,new Promise((t,a)=>{e.storage.sync.set({[this.STORAGE_KEY]:n},()=>{e.runtime.lastError?a(e.runtime.lastError):t(i)})})},async revokeKey(t){const n=await this.getKeys();if(!n[t])throw new Error(`API key ${t} does not exist`);return delete n[t],new Promise((t,a)=>{e.storage.sync.set({[this.STORAGE_KEY]:n},()=>{e.runtime.lastError?a(e.runtime.lastError):t()})})},async getKeyList(){const e=await this.getKeys();return Object.values(e).map(e=>({id:e.id,name:e.name,keyPreview:this.maskKey(e.key),createdAt:e.createdAt,lastUsed:e.lastUsed})).sort((e,t)=>t.createdAt-e.createdAt)},maskKey:e=>!e||e.length<16?"****":`${e.slice(0,11)}...${e.slice(-4)}`,formatLastUsed(e){if(!e)return"Never";const t=Date.now()-e;return t<6e4?"Just now":t<36e5?`${Math.floor(t/6e4)} min ago`:t<864e5?`${Math.floor(t/36e5)} hours ago`:`${Math.floor(t/864e5)} days ago`}};async function ge(){const e="business"===y.tier;$.accountSelectorContainer&&(e?($.accountSelectorContainer.style.display="flex",await ye()):$.accountSelectorContainer.style.display="none"),$.apiSection&&$.apiLocked&&(e?($.apiSection.style.display="block",$.apiLocked.style.display="none",await he()):($.apiSection.style.display="none",$.apiLocked.style.display="block")),function(){$.accountSelect&&$.accountSelect.addEventListener("change",async()=>{const e=$.accountSelect.value;try{await C.setActiveAccount(e),await S(),we(),A.success("Switched setup")}catch(e){A.error("Failed to switch setup"),console.error("[BuzzChat] Account switch error:",e)}});$.newAccountBtn&&$.newAccountBtn.addEventListener("click",async()=>{const e=prompt("Enter a name for the new setup:","My New Setup");if(e)try{const t=await C.createAccount(e);await C.setActiveAccount(t.id),await S(),we(),A.success(`Created "${t.name}"`)}catch(e){A.error(e.message||"Failed to create setup"),console.error("[BuzzChat] Account create error:",e)}});$.manageAccountsBtn&&$.manageAccountsBtn.addEventListener("click",async()=>{await pe(),$.accountManagerModal?.classList.add("active")});$.closeAccountManagerBtn&&$.closeAccountManagerBtn.addEventListener("click",()=>{$.accountManagerModal?.classList.remove("active")});$.createAccountModalBtn&&$.createAccountModalBtn.addEventListener("click",()=>{$.createAccountForm&&($.createAccountForm.style.display="block",$.createAccountModalBtn.style.display="none",$.newAccountName?.focus())});$.cancelCreateAccountBtn&&$.cancelCreateAccountBtn.addEventListener("click",()=>{$.createAccountForm&&($.createAccountForm.style.display="none",$.createAccountModalBtn.style.display="block",$.newAccountName&&($.newAccountName.value=""))});$.confirmCreateAccountBtn&&$.confirmCreateAccountBtn.addEventListener("click",async()=>{const e=$.newAccountName?.value?.trim();if(e)try{T.show($.confirmCreateAccountBtn);const t=await C.createAccount(e);await pe(),await ye(),$.createAccountForm.style.display="none",$.createAccountModalBtn.style.display="block",$.newAccountName.value="",A.success(`Created "${t.name}"`)}catch(e){A.error(e.message||"Failed to create setup")}finally{T.hide($.confirmCreateAccountBtn)}else A.warning("Please enter a setup name")});$.createApiKeyBtn&&$.createApiKeyBtn.addEventListener("click",async()=>{const e=prompt("Enter a name for this API key:","My API Key");if(e)try{T.show($.createApiKeyBtn);const t=await me.createKey(e);$.newApiKeyValue&&($.newApiKeyValue.textContent=t.key),$.apiKeyCreated&&($.apiKeyCreated.style.display="block"),await he(),A.success("API key created")}catch(e){A.error(e.message||"Failed to create API key")}finally{T.hide($.createApiKeyBtn)}});$.copyNewApiKeyBtn&&$.copyNewApiKeyBtn.addEventListener("click",async()=>{const e=$.newApiKeyValue?.textContent;if(e)try{await navigator.clipboard.writeText(e),$.copyNewApiKeyBtn.textContent="Copied!",A.success("API key copied to clipboard"),setTimeout(()=>{$.copyNewApiKeyBtn.textContent="Copy"},2e3)}catch(e){A.error("Failed to copy to clipboard")}});$.closeApiKeyCreatedBtn&&$.closeApiKeyCreatedBtn.addEventListener("click",()=>{$.apiKeyCreated&&($.apiKeyCreated.style.display="none"),$.newApiKeyValue&&($.newApiKeyValue.textContent="")});$.unlockApiBtn&&$.unlockApiBtn.addEventListener("click",()=>{$.upgradeModal?.classList.add("active")})}()}async function ye(){if(!$.accountSelect)return;const e=await C.getAccountList();for(;$.accountSelect.firstChild;)$.accountSelect.removeChild($.accountSelect.firstChild);e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,e.isActive&&(t.selected=!0),$.accountSelect.appendChild(t)})}async function pe(){if(!$.accountsList)return;const e=await C.getAccountList();for(;$.accountsList.firstChild;)$.accountsList.removeChild($.accountsList.firstChild);e.forEach(e=>{const t=document.createElement("div");t.className="account-item "+(e.isActive?"active":""),t.dataset.accountId=e.id;const n=document.createElement("div");n.className="account-item-info";const a=document.createElement("div");a.className="account-item-name",a.textContent=e.name;const s=document.createElement("div");if(s.className="account-item-meta",s.textContent=`Created ${function(e){if(!e)return"Unknown";const t=new Date(e),n=new Date-t;return n<864e5?"today":n<1728e5?"yesterday":n<6048e5?`${Math.floor(n/864e5)} days ago`:t.toLocaleDateString()}(e.createdAt)}`,n.appendChild(a),n.appendChild(s),t.appendChild(n),e.isActive){const e=document.createElement("span");e.className="account-item-badge",e.textContent="Active",t.appendChild(e)}const i=document.createElement("div");if(i.className="account-item-actions",!e.isActive){const t=document.createElement("button");t.className="icon-btn switch-account-btn",t.title="Switch to this setup",t.dataset.id=e.id,t.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>',i.appendChild(t)}if("default"!==e.id){const t=document.createElement("button");t.className="icon-btn danger delete-account-btn",t.title="Delete setup",t.dataset.id=e.id,t.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>',i.appendChild(t)}t.appendChild(i),$.accountsList.appendChild(t)}),$.accountsList.querySelectorAll(".switch-account-btn").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.id;try{await C.setActiveAccount(t),await S(),we(),await pe(),await ye(),A.success("Switched setup")}catch(e){A.error("Failed to switch setup")}})}),$.accountsList.querySelectorAll(".delete-account-btn").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.id;if(confirm("Delete this setup? All settings will be lost. This cannot be undone."))try{await C.deleteAccount(t),await S(),we(),await pe(),await ye(),A.success("Setup deleted")}catch(e){A.error(e.message||"Failed to delete setup")}})})}async function he(){if(!$.apiKeysList)return;const e=await me.getKeyList();for(;$.apiKeysList.firstChild;)$.apiKeysList.removeChild($.apiKeysList.firstChild);0!==e.length?($.emptyKeysMessage&&($.emptyKeysMessage.style.display="none"),e.forEach(e=>{const t=document.createElement("div");t.className="api-key-item",t.dataset.keyId=e.id;const n=document.createElement("div");n.className="api-key-info";const a=document.createElement("div");a.className="api-key-name",a.textContent=e.name;const s=document.createElement("div");s.className="api-key-preview",s.textContent=e.keyPreview;const i=document.createElement("div");i.className="api-key-meta",i.textContent=`Last used: ${me.formatLastUsed(e.lastUsed)}`,n.appendChild(a),n.appendChild(s),n.appendChild(i),t.appendChild(n);const o=document.createElement("div");o.className="api-key-actions";const r=document.createElement("button");r.className="btn btn-danger btn-sm revoke-key-btn",r.dataset.id=e.id,r.textContent="Revoke",o.appendChild(r),t.appendChild(o),$.apiKeysList.appendChild(t)}),$.apiKeysList.querySelectorAll(".revoke-key-btn").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.id;if(confirm("Revoke this API key? Any applications using it will stop working."))try{T.show(e),await me.revokeKey(t),await he(),A.success("API key revoked")}catch(e){A.error(e.message||"Failed to revoke API key")}finally{T.hide(e)}})})):$.emptyKeysMessage&&($.emptyKeysMessage.style.display="block")}function we(){$.masterToggle.checked=y.masterEnabled,z(),F(),$.welcomeToggle.checked=y.welcome.enabled,$.welcomeMessage.value=y.welcome.message,$.welcomeDelay.value=y.welcome.delay,$.timerToggle.checked=y.timer.enabled,U(),$.faqToggle.checked=y.faq.enabled,Y(),H(),$.commandsToggle&&($.commandsToggle.checked=y.commands?.enabled||!1),Q(),$.quickReplyToggle&&($.quickReplyToggle.checked=!1!==y.quickReply?.enabled),ee(),function(){if(!$.quickReplyPosition)return;const e=y.quickReply?.position||"bottom-right";$.quickReplyPosition.value=e,$.quickReplyPosition.addEventListener("change",async()=>{y.quickReply||(y.quickReply={enabled:!0,minimized:!1,buttons:[],position:"bottom-right"}),y.quickReply.position=$.quickReplyPosition.value,await M(),A.success("Position updated")})}(),$.moderationToggle&&($.moderationToggle.checked=y.moderation?.enabled||!1),$.blockedWords&&($.blockedWords.value=(y.moderation?.blockedWords||[]).join(", ")),$.blockRepeatedToggle&&($.blockRepeatedToggle.checked=y.moderation?.blockRepeatedMessages||!1),$.maxRepeatCount&&($.maxRepeatCount.value=y.moderation?.maxRepeatCount||3),$.giveawayToggle&&($.giveawayToggle.checked=y.giveaway?.enabled||!1),$.giveawayKeywords&&($.giveawayKeywords.value=(y.giveaway?.keywords||["entered","entry","enter"]).join(", ")),$.giveawayUniqueToggle&&($.giveawayUniqueToggle.checked=!1!==y.giveaway?.uniqueOnly),re(),ce(),$.chatSelector.value=y.settings.chatSelector,$.soundNotifications.checked=y.settings.soundNotifications,$.showMessageCount.checked=y.settings.showMessageCount,$.darkModeToggle&&($.darkModeToggle.checked=!0===y.settings.darkMode||"auto"===y.settings.darkMode&&window.matchMedia?.("(prefers-color-scheme: dark)").matches,D(y.settings.darkMode)),function(){if(!window.matchMedia)return;window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{"auto"!==y.settings?.darkMode&&void 0!==y.settings?.darkMode||D(e.matches)})}(),$.watermarkToggle&&($.watermarkToggle.checked=y.settings.watermark||!1),ue(),ge()}const ve={STORAGE_KEY:"buzzchatReferral",BONUS_PER_REFERRAL:10,CODE_LENGTH:8,generateCode(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let t="";for(let n=0;n<this.CODE_LENGTH;n++)t+=e.charAt(Math.floor(32*Math.random()));return t},async getData(){return new Promise(t=>{e.storage.local.get([this.STORAGE_KEY],n=>{if(n[this.STORAGE_KEY])t(n[this.STORAGE_KEY]);else{const n={myCode:this.generateCode(),referrals:[],redeemedCode:null,bonusMessages:0,createdAt:Date.now()};e.storage.local.set({[this.STORAGE_KEY]:n}),t(n)}})})},async saveData(t){return new Promise(n=>{e.storage.local.set({[this.STORAGE_KEY]:t},n)})},async redeemCode(e){const t=await this.getData();if(!e||"string"!=typeof e)return{success:!1,error:"Please enter a valid code"};const n=e.trim().toUpperCase();return t.redeemedCode?{success:!1,error:"You have already redeemed a referral code"}:n===t.myCode?{success:!1,error:"You cannot use your own referral code"}:/^[A-Z0-9]{8}$/.test(n)?(t.redeemedCode=n,t.bonusMessages+=this.BONUS_PER_REFERRAL,await this.saveData(t),await this.applyBonus(this.BONUS_PER_REFERRAL),{success:!0,bonus:this.BONUS_PER_REFERRAL}):{success:!1,error:"Invalid code format"}},applyBonus:async t=>new Promise(n=>{e.storage.sync.get(["buzzchatSettings"],a=>{if(a.buzzchatSettings){const s=a.buzzchatSettings;s.referralBonus=(s.referralBonus||0)+t,e.storage.sync.set({buzzchatSettings:s},n)}else n()})}),async getTotalBonus(){return(await this.getData()).bonusMessages},async getReferralCount(){return(await this.getData()).referrals.length}};const fe={EXTENSION_ID:"buzzchat",TRIAL_DAYS:7,CACHE_EXPIRY_MS:864e5,getCachedLicense:async()=>new Promise(t=>{e.storage.sync.get(["buzzchatLicense"],e=>{t(e.buzzchatLicense||null)})}),cacheLicense:async t=>new Promise(n=>{e.storage.sync.set({buzzchatLicense:{...t,cachedAt:Date.now()}},n)}),getUser:async()=>new Promise(t=>{e.storage.sync.get(["extensionpay_user"],e=>{t(e.extensionpay_user||null)})}),async openPaymentPage(t="pro",n=!1){const a=`https://extensionpay.com/pay/${this.EXTENSION_ID}`;let s=a;const i=[];"business"===t&&i.push("plan=business"),n&&i.push("billing=annual"),i.length>0&&(s=`${a}?${i.join("&")}`),e.tabs.create({url:s})},async startTrial(){const t={trialStartedAt:(new Date).toISOString(),extensionId:this.EXTENSION_ID};await new Promise(n=>{e.storage.sync.set({extensionpay_user:t},n)});const n={tier:"pro",paid:!1,trialActive:!0,trialEndsAt:new Date(Date.now()+24*this.TRIAL_DAYS*60*60*1e3).toISOString()};return await this.cacheLicense(n),y.tier="pro",y.messagesLimit=250,await M(),n},async canStartTrial(){const e=await this.getUser();return!e||!e.trialStartedAt},async openManagementPage(){e.tabs.create({url:`https://extensionpay.com/manage/${this.EXTENSION_ID}`})},formatTrialRemaining(e){if(!e)return null;const t=new Date(e)-new Date;if(t<=0)return"Trial expired";const n=Math.floor(t/864e5),a=Math.floor(t%864e5/36e5);return n>0?`${n} day${n>1?"s":""} left`:`${a} hour${a>1?"s":""} left`}};async function Ee(e,t=!1){T.show("pro"===e?$.subscribePro:$.subscribeBusiness);try{await fe.openPaymentPage(e,t),A.success("Opening payment page..."),$.upgradeModal.classList.remove("active")}catch(e){console.error("[BuzzChat] Failed to open payment page:",e),A.error("Failed to open payment page. Please try again.")}T.hide("pro"===e?$.subscribePro:$.subscribeBusiness)}async function Be(){T.show($.startTrialBtn);try{if(!await fe.canStartTrial())return void A.warning("You have already used your free trial.");await fe.startTrial(),A.success("7-day Pro trial activated!"),$.upgradeModal.classList.remove("active"),F(),we()}catch(e){console.error("[BuzzChat] Failed to start trial:",e),A.error("Failed to start trial. Please try again.")}finally{T.hide($.startTrialBtn)}}function be(){T.show($.exportSettingsBtn);try{const e=JSON.stringify(y,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="buzzchat-settings.json",a.click(),URL.revokeObjectURL(n),A.success("Settings exported")}catch(e){A.error("Export failed")}T.hide($.exportSettingsBtn)}async function Ce(e){const t=e.target.files[0];if(t){T.show($.importSettingsBtn);try{const n=await t.text(),a=JSON.parse(n),s=function(e){if("object"!=typeof e||null===e||Array.isArray(e))return{valid:!1,error:"Invalid settings format"};const t=["__proto__","constructor","prototype"],n=(e,a="")=>{if("object"!=typeof e||null===e)return!0;for(const s of Object.keys(e)){if(t.includes(s))return!1;if("object"==typeof e[s]&&null!==e[s]&&!n(e[s],`${a}.${s}`))return!1}return!0};if(!n(e))return{valid:!1,error:"Settings contain unsafe properties"};const a=(e,t=0)=>{if(t>5)return!1;if("string"==typeof e&&e.length>1e3)return!1;if(Array.isArray(e)&&e.length>100)return!1;if("object"==typeof e&&null!==e)for(const n of Object.values(e))if(!a(n,t+1))return!1;return!0};if(!a(e))return{valid:!1,error:"Settings exceed size limits"};if(e.welcome&&"object"!=typeof e.welcome)return{valid:!1,error:"Invalid welcome settings"};if(e.timer){if("object"!=typeof e.timer)return{valid:!1,error:"Invalid timer settings"};if(e.timer.messages&&!Array.isArray(e.timer.messages))return{valid:!1,error:"Timer messages must be an array"}}if(e.faq){if("object"!=typeof e.faq)return{valid:!1,error:"Invalid FAQ settings"};if(e.faq.rules&&!Array.isArray(e.faq.rules))return{valid:!1,error:"FAQ rules must be an array"}}if(e.templates&&!Array.isArray(e.templates))return{valid:!1,error:"Templates must be an array"};if(e.commands){if("object"!=typeof e.commands)return{valid:!1,error:"Invalid commands settings"};if(e.commands.list&&!Array.isArray(e.commands.list))return{valid:!1,error:"Commands list must be an array"}}if(e.quickReply){if("object"!=typeof e.quickReply)return{valid:!1,error:"Invalid quickReply settings"};if(e.quickReply.buttons&&!Array.isArray(e.quickReply.buttons))return{valid:!1,error:"Quick reply buttons must be an array"}}const s=["tier","messagesUsed","messagesLimit","referralBonus","masterEnabled","welcome","timer","faq","moderation","giveaway","templates","commands","quickReply","settings"];for(const t of Object.keys(e))s.includes(t)||delete e[t];return{valid:!0}}(a);if(!s.valid)return A.error(s.error),T.hide($.importSettingsBtn),void(e.target.value="");p({...g,...a}),await M(),we(),A.success("Settings imported successfully")}catch(e){A.error("Invalid settings file")}T.hide($.importSettingsBtn),e.target.value=""}}const Ae={currentStep:1,totalSteps:3,async check(){!(await e.storage.sync.get(["buzzchatOnboarded"])).buzzchatOnboarded&&$.onboardingModal&&($.onboardingModal.classList.add("active"),N.activate($.onboardingModal),this.updateUI())},updateUI(){document.querySelectorAll(".onboarding-step").forEach(e=>{const t=parseInt(e.dataset.step);e.classList.remove("active","completed"),t===this.currentStep?e.classList.add("active"):t<this.currentStep&&e.classList.add("completed")}),document.querySelectorAll(".onboarding-panel").forEach(e=>{e.classList.remove("active")});const e=document.getElementById(`onboarding-step-${this.currentStep}`);e&&e.classList.add("active"),$.onboardingPrevBtn&&($.onboardingPrevBtn.style.visibility=1===this.currentStep?"hidden":"visible"),$.onboardingNextBtn&&($.onboardingNextBtn.textContent=this.currentStep===this.totalSteps?"Get Started":"Next",this.updateNextButtonState())},updateNextButtonState(){$.onboardingNextBtn&&(1===this.currentStep?$.onboardingNextBtn.disabled=!$.acceptTerms?.checked:$.onboardingNextBtn.disabled=!1)},nextStep(){this.currentStep<this.totalSteps?(this.currentStep++,this.updateUI()):this.complete()},prevStep(){this.currentStep>1&&(this.currentStep--,this.updateUI())},updateMessagePreview(){if($.onboardingMessage&&$.messagePreview){const e=($.onboardingMessage.value||"").replace(/{username}/gi,"StreamViewer");$.messagePreview.textContent=e||"Your message preview will appear here..."}},async complete(){$.setupWelcome?.checked&&(y.welcome.enabled=!0,$.onboardingMessage?.value&&(y.welcome.message=$.onboardingMessage.value)),$.setupTimer?.checked&&(y.timer.enabled=!0),$.setupFaq?.checked&&(y.faq.enabled=!0),await M(),await e.storage.sync.set({buzzchatOnboarded:!0}),$.onboardingModal&&($.onboardingModal.classList.remove("active"),N.deactivate()),we(),A.success("You're all set! Enable the bot when you're ready to go live.")}};document.addEventListener("DOMContentLoaded",async()=>{$.masterToggle=document.getElementById("masterToggle"),$.statusBadge=document.getElementById("statusBadge"),$.tierBanner=document.getElementById("tierBanner"),$.welcomeToggle=document.getElementById("welcomeToggle"),$.welcomeMessage=document.getElementById("welcomeMessage"),$.welcomeDelay=document.getElementById("welcomeDelay"),$.timerToggle=document.getElementById("timerToggle"),$.timerMessages=document.getElementById("timerMessages"),$.addTimerBtn=document.getElementById("addTimerBtn"),$.timerMessageTemplate=document.getElementById("timerMessageTemplate"),$.faqToggle=document.getElementById("faqToggle"),$.faqItems=document.getElementById("faqItems"),$.addFaqBtn=document.getElementById("addFaqBtn"),$.faqTemplate=document.getElementById("faqTemplate"),$.templatesList=document.getElementById("templatesList"),$.addTemplateBtn=document.getElementById("addTemplateBtn"),$.templateTemplate=document.getElementById("templateTemplate"),$.settingsModal=document.getElementById("settingsModal"),$.settingsBtn=document.getElementById("settingsBtn"),$.closeSettingsBtn=document.getElementById("closeSettingsBtn"),$.upgradeModal=document.getElementById("upgradeModal"),$.upgradeBtn=document.getElementById("upgradeBtn"),$.closeUpgradeBtn=document.getElementById("closeUpgradeBtn"),$.helpModal=document.getElementById("helpModal"),$.helpBtn=document.getElementById("helpBtn"),$.closeHelpBtn=document.getElementById("closeHelpBtn"),$.chatSelector=document.getElementById("chatSelector"),$.soundNotifications=document.getElementById("soundNotifications"),$.showMessageCount=document.getElementById("showMessageCount"),$.darkModeToggle=document.getElementById("darkModeToggle"),$.exportSettingsBtn=document.getElementById("exportSettingsBtn"),$.importSettingsBtn=document.getElementById("importSettingsBtn"),$.importFile=document.getElementById("importFile"),$.subscribePro=document.getElementById("subscribePro"),$.subscribeBusiness=document.getElementById("subscribeBusiness"),$.startTrialBtn=document.getElementById("startTrialBtn"),$.trialBanner=document.getElementById("trialBanner"),$.annualBillingToggle=document.getElementById("annualBillingToggle"),$.proPrice=document.getElementById("proPrice"),$.proPriceAnnual=document.getElementById("proPriceAnnual"),$.proPriceNote=document.getElementById("proPriceNote"),$.businessPrice=document.getElementById("businessPrice"),$.businessPriceAnnual=document.getElementById("businessPriceAnnual"),$.businessPriceNote=document.getElementById("businessPriceNote"),$.watermarkToggle=document.getElementById("watermarkToggle"),$.onboardingModal=document.getElementById("onboardingModal"),$.acceptTerms=document.getElementById("acceptTerms"),$.onboardingPrevBtn=document.getElementById("onboardingPrevBtn"),$.onboardingNextBtn=document.getElementById("onboardingNextBtn"),$.onboardingMessage=document.getElementById("onboardingMessage"),$.messagePreview=document.getElementById("messagePreview"),$.setupWelcome=document.getElementById("setupWelcome"),$.setupTimer=document.getElementById("setupTimer"),$.setupFaq=document.getElementById("setupFaq"),$.saveIndicator=document.getElementById("saveIndicator"),$.moderationToggle=document.getElementById("moderationToggle"),$.blockedWords=document.getElementById("blockedWords"),$.blockRepeatedToggle=document.getElementById("blockRepeatedToggle"),$.maxRepeatCount=document.getElementById("maxRepeatCount"),$.giveawayToggle=document.getElementById("giveawayToggle"),$.giveawayKeywords=document.getElementById("giveawayKeywords"),$.giveawayUniqueToggle=document.getElementById("giveawayUniqueToggle"),$.giveawayEntryCount=document.getElementById("giveawayEntryCount"),$.giveawayEntriesList=document.getElementById("giveawayEntriesList"),$.refreshGiveawayBtn=document.getElementById("refreshGiveawayBtn"),$.resetGiveawayBtn=document.getElementById("resetGiveawayBtn"),$.metricMessagesPerMin=document.getElementById("metricMessagesPerMin"),$.metricUniqueChatters=document.getElementById("metricUniqueChatters"),$.metricPeakMsgs=document.getElementById("metricPeakMsgs"),$.refreshMetricsBtn=document.getElementById("refreshMetricsBtn"),$.analyticsLocked=document.getElementById("analyticsLocked"),$.analyticsContent=document.getElementById("analyticsContent"),$.unlockAnalyticsBtn=document.getElementById("unlockAnalyticsBtn"),$.exportAnalyticsBtn=document.getElementById("exportAnalyticsBtn"),$.statTotalMessages=document.getElementById("statTotalMessages"),$.statTodayMessages=document.getElementById("statTodayMessages"),$.statPeakHour=document.getElementById("statPeakHour"),$.weeklyChart=document.getElementById("weeklyChart"),$.typePieChart=document.getElementById("typePieChart"),$.legendWelcome=document.getElementById("legendWelcome"),$.legendFaq=document.getElementById("legendFaq"),$.legendTimer=document.getElementById("legendTimer"),$.legendTemplate=document.getElementById("legendTemplate"),$.faqTriggersList=document.getElementById("faqTriggersList"),$.referralCode=document.getElementById("referralCode"),$.copyReferralBtn=document.getElementById("copyReferralBtn"),$.referralCount=document.getElementById("referralCount"),$.referralBonus=document.getElementById("referralBonus"),$.redeemCode=document.getElementById("redeemCode"),$.redeemCodeBtn=document.getElementById("redeemCodeBtn"),$.referralRedeemedMsg=document.getElementById("referralRedeemedMsg"),$.accountSelectorContainer=document.getElementById("accountSelectorContainer"),$.accountSelect=document.getElementById("accountSelect"),$.newAccountBtn=document.getElementById("newAccountBtn"),$.manageAccountsBtn=document.getElementById("manageAccountsBtn"),$.accountManagerModal=document.getElementById("accountManagerModal"),$.closeAccountManagerBtn=document.getElementById("closeAccountManagerBtn"),$.accountsList=document.getElementById("accountsList"),$.createAccountModalBtn=document.getElementById("createAccountModalBtn"),$.createAccountForm=document.getElementById("createAccountForm"),$.newAccountName=document.getElementById("newAccountName"),$.confirmCreateAccountBtn=document.getElementById("confirmCreateAccountBtn"),$.cancelCreateAccountBtn=document.getElementById("cancelCreateAccountBtn"),$.apiSection=document.getElementById("apiSection"),$.apiLocked=document.getElementById("apiLocked"),$.apiKeysList=document.getElementById("apiKeysList"),$.emptyKeysMessage=document.getElementById("emptyKeysMessage"),$.createApiKeyBtn=document.getElementById("createApiKeyBtn"),$.apiKeyCreated=document.getElementById("apiKeyCreated"),$.newApiKeyValue=document.getElementById("newApiKeyValue"),$.copyNewApiKeyBtn=document.getElementById("copyNewApiKeyBtn"),$.closeApiKeyCreatedBtn=document.getElementById("closeApiKeyCreatedBtn"),$.unlockApiBtn=document.getElementById("unlockApiBtn"),$.commandsToggle=document.getElementById("commandsToggle"),$.commandsList=document.getElementById("commandsList"),$.addCommandBtn=document.getElementById("addCommandBtn"),$.commandTemplate=document.getElementById("commandTemplate"),$.exportCommandsBtn=document.getElementById("exportCommandsBtn"),$.importCommandsBtn=document.getElementById("importCommandsBtn"),$.importCommandsFile=document.getElementById("importCommandsFile"),$.spinWheelBtn=document.getElementById("spinWheelBtn"),$.winnerCount=document.getElementById("winnerCount"),$.winnerDisplay=document.getElementById("winnerDisplay"),$.winnerNames=document.getElementById("winnerNames"),$.announceWinnerBtn=document.getElementById("announceWinnerBtn"),$.rerollWinnerBtn=document.getElementById("rerollWinnerBtn"),$.closeWinnerBtn=document.getElementById("closeWinnerBtn"),$.wheelOverlay=document.getElementById("wheelOverlay"),$.spinningWheel=document.getElementById("spinningWheel"),$.wheelStatus=document.getElementById("wheelStatus"),$.confettiCanvas=document.getElementById("confettiCanvas"),$.quickReplyToggle=document.getElementById("quickReplyToggle"),$.quickReplyPosition=document.getElementById("quickReplyPosition"),$.quickReplyButtonsList=document.getElementById("quickReplyButtonsList"),$.addQuickReplyBtn=document.getElementById("addQuickReplyBtn"),$.quickReplyTemplate=document.getElementById("quickReplyTemplate"),await S(),we(),function(){(function(){const e=document.querySelectorAll(".tab-btn"),t=document.querySelectorAll(".tab-panel");e.forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.tab;e.forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-selected","false")}),t.forEach(e=>e.classList.remove("active")),n.classList.add("active"),n.setAttribute("aria-selected","true");const s=document.getElementById(`${a}-panel`);s&&s.classList.add("active")}),n.addEventListener("keydown",t=>{const a=Array.from(e),s=a.indexOf(n);if("ArrowRight"===t.key){t.preventDefault();const e=(s+1)%a.length;a[e].focus(),a[e].click()}else if("ArrowLeft"===t.key){t.preventDefault();const e=(s-1+a.length)%a.length;a[e].focus(),a[e].click()}})})})(),$.acceptTerms&&$.acceptTerms.addEventListener("change",()=>{Ae.updateNextButtonState()}),$.onboardingNextBtn&&$.onboardingNextBtn.addEventListener("click",()=>{Ae.nextStep()}),$.onboardingPrevBtn&&$.onboardingPrevBtn.addEventListener("click",()=>{Ae.prevStep()}),void($.onboardingMessage&&$.onboardingMessage.addEventListener("input",()=>{Ae.updateMessagePreview()})),$.masterToggle.addEventListener("change",async()=>{y.masterEnabled=$.masterToggle.checked,z(),await M(),A.success(y.masterEnabled?"Bot activated":"Bot deactivated")}),$.welcomeToggle.addEventListener("change",async()=>{y.welcome.enabled=$.welcomeToggle.checked,await M()}),$.welcomeMessage.addEventListener("input",I(async()=>{y.welcome.message=x($.welcomeMessage.value),await M()},500)),$.welcomeDelay.addEventListener("change",async()=>{const e=q($.welcomeDelay.value,l,d,5);y.welcome.delay=e,$.welcomeDelay.value=e,await M()}),$.timerToggle.addEventListener("change",async()=>{y.timer.enabled=$.timerToggle.checked,await M()}),$.addTimerBtn.addEventListener("click",()=>{j()}),$.faqToggle.addEventListener("change",async()=>{y.faq.enabled=$.faqToggle.checked,await M()}),$.addFaqBtn.addEventListener("click",()=>{G()}),$.moderationToggle&&$.moderationToggle.addEventListener("change",async()=>{y.moderation||(y.moderation={}),y.moderation.enabled=$.moderationToggle.checked,await M()});$.blockedWords&&$.blockedWords.addEventListener("input",I(async()=>{y.moderation||(y.moderation={}),y.moderation.blockedWords=$.blockedWords.value.split(",").map(e=>e.trim()).filter(e=>e.length>0),await M()},500));$.blockRepeatedToggle&&$.blockRepeatedToggle.addEventListener("change",async()=>{y.moderation||(y.moderation={}),y.moderation.blockRepeatedMessages=$.blockRepeatedToggle.checked,await M()});$.maxRepeatCount&&$.maxRepeatCount.addEventListener("change",async()=>{y.moderation||(y.moderation={}),y.moderation.maxRepeatCount=q($.maxRepeatCount.value,2,10,3),$.maxRepeatCount.value=y.moderation.maxRepeatCount,await M()});$.giveawayToggle&&$.giveawayToggle.addEventListener("change",async()=>{y.giveaway||(y.giveaway={}),y.giveaway.enabled=$.giveawayToggle.checked,await M()});$.giveawayKeywords&&$.giveawayKeywords.addEventListener("input",I(async()=>{y.giveaway||(y.giveaway={}),y.giveaway.keywords=$.giveawayKeywords.value.split(",").map(e=>e.trim()).filter(e=>e.length>0),await M()},500));$.giveawayUniqueToggle&&$.giveawayUniqueToggle.addEventListener("change",async()=>{y.giveaway||(y.giveaway={}),y.giveaway.uniqueOnly=$.giveawayUniqueToggle.checked,await M()});$.refreshGiveawayBtn&&$.refreshGiveawayBtn.addEventListener("click",re);$.resetGiveawayBtn&&$.resetGiveawayBtn.addEventListener("click",async()=>{confirm("Reset all giveaway entries? This cannot be undone.")&&(await L("RESET_GIVEAWAY"),re(),A.success("Giveaway entries reset"))});$.refreshMetricsBtn&&$.refreshMetricsBtn.addEventListener("click",ce);$.spinWheelBtn&&($.spinWheelBtn.addEventListener("click",ne),$.spinWheelBtn.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),ne())}));$.announceWinnerBtn&&$.announceWinnerBtn.addEventListener("click",ie);$.rerollWinnerBtn&&$.rerollWinnerBtn.addEventListener("click",()=>{se(),ne()});$.closeWinnerBtn&&$.closeWinnerBtn.addEventListener("click",se);$.addTemplateBtn.addEventListener("click",()=>{V()}),$.commandsToggle&&$.commandsToggle.addEventListener("change",async()=>{y.commands||(y.commands={enabled:!1,list:[]}),y.commands.enabled=$.commandsToggle.checked,await M()});$.addCommandBtn&&$.addCommandBtn.addEventListener("click",()=>{X()});$.exportCommandsBtn&&$.exportCommandsBtn.addEventListener("click",J);$.importCommandsBtn&&$.importCommandsBtn.addEventListener("click",()=>{$.importCommandsFile?.click()});$.importCommandsFile&&$.importCommandsFile.addEventListener("change",Z);$.quickReplyToggle&&$.quickReplyToggle.addEventListener("change",async()=>{y.quickReply||(y.quickReply={enabled:!0,minimized:!1,buttons:[]}),y.quickReply.enabled=$.quickReplyToggle.checked,await M()});$.addQuickReplyBtn&&$.addQuickReplyBtn.addEventListener("click",te);$.settingsBtn.addEventListener("click",()=>{K($.settingsModal)}),$.closeSettingsBtn.addEventListener("click",()=>{_($.settingsModal)}),$.upgradeBtn.addEventListener("click",()=>{K($.upgradeModal)}),$.closeUpgradeBtn.addEventListener("click",()=>{_($.upgradeModal)}),$.helpBtn&&$.helpBtn.addEventListener("click",()=>{K($.helpModal)});$.closeHelpBtn&&$.closeHelpBtn.addEventListener("click",()=>{_($.helpModal)});$.chatSelector.addEventListener("input",I(async()=>{y.settings.chatSelector=$.chatSelector.value,await M()},500)),$.soundNotifications.addEventListener("change",async()=>{y.settings.soundNotifications=$.soundNotifications.checked,await M()}),$.showMessageCount.addEventListener("change",async()=>{y.settings.showMessageCount=$.showMessageCount.checked,await M()}),$.darkModeToggle&&$.darkModeToggle.addEventListener("change",async()=>{y.settings.darkMode=$.darkModeToggle.checked,D(y.settings.darkMode),await M()});$.exportSettingsBtn.addEventListener("click",be),$.importSettingsBtn.addEventListener("click",()=>$.importFile.click()),$.importFile.addEventListener("change",Ce),$.annualBillingToggle&&$.annualBillingToggle.addEventListener("change",()=>{!function(e){$.proPrice&&($.proPrice.style.display=e?"none":"block"),$.proPriceAnnual&&($.proPriceAnnual.style.display=e?"block":"none"),$.proPriceNote&&($.proPriceNote.style.display=e?"block":"none"),$.businessPrice&&($.businessPrice.style.display=e?"none":"block"),$.businessPriceAnnual&&($.businessPriceAnnual.style.display=e?"block":"none"),$.businessPriceNote&&($.businessPriceNote.style.display=e?"block":"none")}($.annualBillingToggle.checked)});$.watermarkToggle&&$.watermarkToggle.addEventListener("change",async()=>{y.settings.watermark=$.watermarkToggle.checked,await M(),A.success(y.settings.watermark?"Watermark enabled - help spread the word!":"Watermark disabled."),F()});$.subscribePro.addEventListener("click",()=>Ee("pro",$.annualBillingToggle?.checked)),$.subscribeBusiness.addEventListener("click",()=>Ee("business",$.annualBillingToggle?.checked)),$.startTrialBtn&&$.startTrialBtn.addEventListener("click",Be);(async function(){const e=await fe.canStartTrial(),t=await fe.getCachedLicense();if($.trialBanner&&(!e||t&&(t.paid||t.trialActive)?$.trialBanner.classList.add("hidden"):$.trialBanner.classList.remove("hidden")),t?.trialActive){const e=fe.formatTrialRemaining(t.trialEndsAt),n=$.tierBanner?.querySelector(".tier-usage");n&&e&&(n.textContent=`Trial: ${e}`)}})(),$.unlockAnalyticsBtn&&$.unlockAnalyticsBtn.addEventListener("click",()=>{K($.upgradeModal)});$.exportAnalyticsBtn&&$.exportAnalyticsBtn.addEventListener("click",async()=>{T.show($.exportAnalyticsBtn);try{await de.exportCSV(),A.success("Analytics exported to CSV")}catch(e){A.error("Failed to export analytics")}T.hide($.exportAnalyticsBtn)});O($.settingsModal),O($.upgradeModal),e.runtime.onMessage.addListener((t,n,a)=>{if(!n||n.id!==e.runtime.id)return void console.warn("[BuzzChat] Message from unknown sender rejected");if(!t||"object"!=typeof t||"string"!=typeof t.type)return void console.warn("[BuzzChat] Invalid message format rejected");if(["MESSAGE_SENT","GIVEAWAY_ENTRY","CHAT_METRICS_UPDATE","COMMAND_USED"].includes(t.type))if("MESSAGE_SENT"===t.type)y.messagesUsed++,F(),M();else if("COMMAND_USED"===t.type){if(y.commands?.list&&"string"==typeof t.trigger){const e=y.commands.list.find(e=>e.trigger===t.trigger);e&&"number"==typeof t.usageCount&&(e.usageCount=t.usageCount,Q())}}else"GIVEAWAY_ENTRY"===t.type?($.giveawayEntryCount&&"number"==typeof t.totalEntries&&($.giveawayEntryCount.textContent=Math.max(0,Math.floor(t.totalEntries))),re()):"CHAT_METRICS_UPDATE"===t.type&&t.metrics&&"object"==typeof t.metrics&&le(t.metrics);else console.warn("[BuzzChat] Unknown message type rejected:",t.type)})}(),async function(){try{const e=await ve.getData();$.referralCode&&($.referralCode.value=e.myCode),$.referralCount&&($.referralCount.textContent=e.referrals.length),$.referralBonus&&($.referralBonus.textContent=e.bonusMessages),e.redeemedCode&&($.redeemCode&&($.redeemCode.value=e.redeemedCode,$.redeemCode.disabled=!0),$.redeemCodeBtn&&($.redeemCodeBtn.disabled=!0,$.redeemCodeBtn.textContent="Redeemed"),$.referralRedeemedMsg&&($.referralRedeemedMsg.style.display="block")),$.copyReferralBtn&&$.copyReferralBtn.addEventListener("click",async()=>{const e=$.referralCode?.value;if(e)try{await navigator.clipboard.writeText(e),$.copyReferralBtn.textContent="Copied!",A.success("Referral code copied to clipboard"),setTimeout(()=>{$.copyReferralBtn.textContent="Copy"},2e3)}catch(e){$.referralCode.select(),document.execCommand("copy"),$.copyReferralBtn.textContent="Copied!",A.success("Referral code copied"),setTimeout(()=>{$.copyReferralBtn.textContent="Copy"},2e3)}}),$.redeemCodeBtn&&$.redeemCodeBtn.addEventListener("click",async()=>{const e=$.redeemCode?.value?.trim();if(!e)return void A.warning("Please enter a referral code");T.show($.redeemCodeBtn);const t=await ve.redeemCode(e);if(T.hide($.redeemCodeBtn),t.success){A.success(`Code redeemed! +${t.bonus} bonus messages added`),$.redeemCode.disabled=!0,$.redeemCodeBtn.disabled=!0,$.redeemCodeBtn.textContent="Redeemed",$.referralRedeemedMsg&&($.referralRedeemedMsg.style.display="block");const e=await ve.getData();$.referralBonus&&($.referralBonus.textContent=e.bonusMessages),F()}else A.error(t.error)})}catch(e){console.error("[BuzzChat] Failed to initialize referral:",e)}}(),async function(){await Ae.check()}(),window.__POPUP_INITIALIZED__=!0,setTimeout(()=>{!async function(){try{const e=await de.checkMilestones();if(e.length>0){const t=e[0];oe(),A.success(`${t.title} ${t.message}`),e.length>1&&setTimeout(()=>{A.info(`+${e.length-1} more milestone${e.length>2?"s":""} unlocked!`)},3e3)}}catch(e){console.error("[BuzzChat] Failed to check milestones:",e)}}()},1e3)})}();
