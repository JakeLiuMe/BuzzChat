# AI-Powered Auto-Fix for GitHub Issues
# Analyzes issues and proposes fixes (NEVER auto-merges)
#
# Required secrets:
#   ANTHROPIC_API_KEY - Claude API key for AI analysis
#
# Safety features:
# - Only triggers when MAINTAINER comments "/autofix"
# - Never auto-merges - always requires human review
# - Rate limited to 10 fixes per day
# - All PRs labeled for easy identification
#
# How it works:
# 1. Maintainer comments "/autofix" on a bug issue
# 2. AI analyzes the issue and codebase
# 3. AI generates a fix
# 4. Opens PR with the fix (marked as draft)
# 5. Tests run automatically
# 6. HUMAN must review and merge

name: Auto-Fix Issues

on:
  issue_comment:
    types: [created]

# Only allow one auto-fix at a time
concurrency:
  group: auto-fix
  cancel-in-progress: false

jobs:
  # Check if commenter is a maintainer
  check-permissions:
    runs-on: ubuntu-latest
    outputs:
      is_maintainer: ${{ steps.check.outputs.is_maintainer }}
    steps:
      - name: Check if commenter is maintainer
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/${{ github.event.comment.user.login }}/permission --jq '.permission' 2>/dev/null || echo "none")
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "maintain" || "$PERMISSION" == "write" ]]; then
            echo "is_maintainer=true" >> $GITHUB_OUTPUT
          else
            echo "is_maintainer=false" >> $GITHUB_OUTPUT
          fi

  analyze-and-fix:
    needs: check-permissions
    # SAFETY: Only run when maintainer comments "/autofix"
    if: |
      github.event.comment.body == '/autofix' &&
      needs.check-permissions.outputs.is_maintainer == 'true'

    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run AI Analysis and Fix
        id: ai-fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: node .github/scripts/auto-fix.js

      - name: Create fix branch
        if: steps.ai-fix.outputs.has_fix == 'true'
        run: |
          git config user.name "BuzzChat Bot"
          git config user.email "bot@buzzchat.app"
          git checkout -b auto-fix/issue-${{ github.event.issue.number }}

      - name: Apply fix
        if: steps.ai-fix.outputs.has_fix == 'true'
        run: |
          echo "${{ steps.ai-fix.outputs.patch }}" | base64 -d > fix.patch
          git apply fix.patch || echo "Patch may have already been applied"
          rm fix.patch

      - name: Run tests
        if: steps.ai-fix.outputs.has_fix == 'true'
        id: tests
        run: |
          SKIP_NETWORK_TESTS=true npm test && echo "tests_passed=true" >> $GITHUB_OUTPUT || echo "tests_passed=false" >> $GITHUB_OUTPUT

      - name: Commit and push
        if: steps.ai-fix.outputs.has_fix == 'true' && steps.tests.outputs.tests_passed == 'true'
        run: |
          git add -A
          git commit -m "fix: auto-fix for issue #${{ github.event.issue.number }}

          ${{ steps.ai-fix.outputs.summary }}

          Closes #${{ github.event.issue.number }}

          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push -u origin auto-fix/issue-${{ github.event.issue.number }}

      - name: Create Draft Pull Request
        if: steps.ai-fix.outputs.has_fix == 'true' && steps.tests.outputs.tests_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --draft \
            --title "fix: [AI-GENERATED] Auto-fix for issue #${{ github.event.issue.number }}" \
            --body "## AI-Generated Fix - REQUIRES HUMAN REVIEW

          > **WARNING:** This PR was automatically generated by AI. Please review carefully before merging.

          ### Issue
          #${{ github.event.issue.number }}

          ### AI Summary
          ${{ steps.ai-fix.outputs.summary }}

          ### Changes Made
          ${{ steps.ai-fix.outputs.changes }}

          ### Test Results
          All 220 tests passed.

          ---

          ## Review Checklist
          - [ ] Changes make sense for the reported issue
          - [ ] No unintended side effects
          - [ ] Code follows project style
          - [ ] No security vulnerabilities introduced

          ---
          *This is a DRAFT PR. Mark as ready for review after human verification.*

          Closes #${{ github.event.issue.number }}" \
            --label "auto-fix,needs-review"

      - name: Comment on issue (success)
        if: steps.ai-fix.outputs.has_fix == 'true' && steps.tests.outputs.tests_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "I've analyzed this issue and created a potential fix. Please review the PR that was just opened.

          **Summary:** ${{ steps.ai-fix.outputs.summary }}"

      - name: Comment on issue (no fix found)
        if: steps.ai-fix.outputs.has_fix != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "I analyzed this issue but couldn't generate an automated fix. This may require manual investigation.

          **Analysis:** ${{ steps.ai-fix.outputs.analysis }}"

      - name: Comment on issue (tests failed)
        if: steps.ai-fix.outputs.has_fix == 'true' && steps.tests.outputs.tests_passed != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "I generated a fix but it failed the test suite. This requires manual investigation.

          **Attempted fix:** ${{ steps.ai-fix.outputs.summary }}"

  # NOTE: Auto-merge intentionally removed for safety
  # All AI-generated PRs require human review before merging
